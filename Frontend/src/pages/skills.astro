---
import Nav from "../components/nav.astro";
const API_BASE_VALUE = import.meta.env.PUBLIC_API_BASE || "http://localhost:3001";
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles/global.css" />
    <link rel="stylesheet" href="/styles/skills.css" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <title>Skills | Deante Mirijello</title>
  </head>

  <body>
    <Nav />
    <main data-api-base={API_BASE_VALUE}>
      <header class="page-header">
        <h1 data-i18n="skills.title">Skills</h1>
        <p class="muted" data-i18n="skills.subtitle">Technologies and tools I work with.</p>
      </header>

      <section>
        <div id="skills_grid" class="skills-grid"></div>
      </section>
    </main>

    <script type="module">
      const API_BASE = (() => {
        const envBase = document.querySelector("main").dataset.apiBase;
        const host = location.hostname;
        if (host === "localhost" || host === "127.0.0.1") return "http://localhost:3001";
        return envBase;
      })();
      const grid = document.getElementById("skills_grid");
      let cachedSkills = null;
      let cachedTitles = null;
      let cachedMeta = null;

      function t(key, fallback) {
        return window.__dict?.[key] ?? fallback;
      }

      function renderSkills(skills, titles, meta) {
        grid.innerHTML = "";
        const lang = window.__lang || "en";
        const items = [];
        Object.entries(skills).forEach(([cat, arr]) => {
          arr.forEach((name) => {
            items.push({
              name,
              category: cat,
              image: meta[name]?.image || "/assets/placeholder-skill.svg",
              rating: Math.max(1, Math.min(5, meta[name]?.rating ?? 3)),
            });
          });
        });

        items.sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name));
        items.forEach((it) => {
          const card = document.createElement("div");
          card.className = "skill-card";
          const categoryTitle = titles?.[it.category]?.[lang] || titles?.[it.category]?.en || it.category;
          const ratingLabel = t("skills.ratingLabel", "Rating {rating} of 5").replace("{rating}", String(it.rating));
          card.innerHTML = `
            <div class="skill-img-wrap">
              <img src="${it.image}" alt="${it.name} logo" class="skill-img" />
            </div>
            <div class="skill-info">
              <div class="skill-header">
                <div class="skill-title">${it.name}</div>
              </div>
              <div class="skill-sub">${categoryTitle}</div>
              <div class="skill-rating" aria-label="${ratingLabel}">
                ${"★".repeat(it.rating)}${"☆".repeat(5 - it.rating)}
              </div>
            </div>
          `;
          grid.appendChild(card);
        });

        if (!items.length) {
          grid.innerHTML = `<p class="muted">${t("skills.empty", "No skills yet.")}</p>`;
        }
      }

      async function loadSkills() {
        grid.innerHTML = t("skills.loading", "Loading...");
        try {
          const [skillsRes, titlesRes] = await Promise.all([
            fetch(`${API_BASE}/skills`),
            fetch(`${API_BASE}/skills/titles`),
          ]);
          const metaRes = await fetch(`/assets/skill-meta.json`);

          if (!skillsRes.ok || !titlesRes.ok || !metaRes.ok) {
            throw new Error(`Failed (${skillsRes.status}/${titlesRes.status}/${metaRes.status})`);
          }

          cachedSkills = await skillsRes.json();
          cachedTitles = await titlesRes.json();
          cachedMeta = await metaRes.json();
          renderSkills(cachedSkills, cachedTitles, cachedMeta);
        } catch (e) {
          console.error(e);
          grid.textContent = t("skills.failed", "Failed to load skills.");
        }
      }

      loadSkills();
      document.addEventListener("i18n:change", () => {
        if (cachedSkills && cachedTitles && cachedMeta) {
          renderSkills(cachedSkills, cachedTitles, cachedMeta);
          return;
        }
        loadSkills();
      });
    </script>
    <script type="module" src="/js/i18n.js"></script>
  </body>
</html>
