---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/nav.astro";
const API_BASE_VALUE = import.meta.env.PUBLIC_API_BASE || "http://localhost:3001";
---

<Layout>
  <Nav />
  <main data-api-base={API_BASE_VALUE}>
    <header class="page-header">
      <h1 data-i18n="testimonials.title">Testimonials</h1>
      <p class="muted" data-i18n="testimonials.subtitle">Feedback from teachers and supervisors.</p>
    </header>

    <section class="contact-card" id="guestCard">
      <h2 style="margin-top:0" data-i18n="testimonials.shareTitle">Share feedback</h2>
      <p class="muted" data-i18n="testimonials.loginPrompt">Log in or create a quick account to post a testimonial.</p>
      <div style="display:flex; gap:.5rem; flex-wrap:wrap">
        <button type="button" id="guestLoginBtn" data-i18n="auth.login">Log in</button>
        <button type="button" id="guestSignupBtn" data-i18n="auth.create">Create account</button>
      </div>
    </section>

    <section class="contact-card" id="submitCard" hidden>
      <h2 style="margin-top:0" data-i18n="testimonials.addTitle">Add your testimonial</h2>
      <p class="muted" id="submitHint" data-i18n="testimonials.submitHint">Log in to submit a testimonial.</p>
      <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
        <button type="button" id="openTestimonialModal" class="lang-btn" data-i18n="testimonials.addBtn">Add testimonial</button>
        <button type="button" id="loginFromForm" class="lang-btn" style="display:none" data-i18n="auth.login">Log in</button>
        <span id="tMsg" class="muted"></span>
      </div>
    </section>

    <section class="contact-card" id="listCard" hidden>
      <div id="items"></div>
    </section>

    <div id="testimonialModal" class="modal-overlay" hidden>
      <div class="modal-card contact-card" role="dialog" aria-modal="true" aria-labelledby="testimonialModalTitle">
        <h3 id="testimonialModalTitle" style="margin-top:0" data-i18n="testimonials.modalTitle">Add your testimonial</h3>
        <form id="testimonialForm">
          <label for="tAuthor" class="contact-label" data-i18n="testimonials.form.name">Name</label>
          <input id="tAuthor" class="contact-form-input" name="author" placeholder="Your name" required minlength="2" />

          <label for="tEmail" class="contact-label" style="margin-top:.5rem; display:block;" data-i18n="testimonials.form.email">Email</label>
          <input id="tEmail" class="contact-form-input" name="email" type="email" readonly />

          <label for="tRole" class="contact-label" style="margin-top:.5rem; display:block;" data-i18n="testimonials.form.role">Role (optional)</label>
          <input id="tRole" class="contact-form-input" name="role" placeholder="Your role" />

          <label for="tQuote" class="contact-label" style="margin-top:.5rem; display:block;" data-i18n="testimonials.form.quote">Testimonial</label>
          <textarea id="tQuote" class="contact-form-input contact-form-textarea" name="quote" placeholder="Your testimonial (min 10 chars)" minlength="10" required></textarea>

          <div style="margin-top:.75rem; display:flex; gap:.5rem; justify-content:flex-end; align-items:center;">
            <button type="button" id="closeTestimonialModal" class="lang-btn" data-i18n="testimonials.cancel">Cancel</button>
            <button type="submit" class="lang-btn" data-i18n="testimonials.send">Send</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    const API_BASE = (() => {
      const envBase = document.querySelector("main").dataset.apiBase;
      const host = location.hostname;
      if (host === "localhost" || host === "127.0.0.1") return "http://localhost:3001";
      return envBase;
    })();
    const API = `${API_BASE}/testimonials`;
    const listCard = document.getElementById("listCard");
    const itemsDiv = document.getElementById("items");
    const submitCard = document.getElementById("submitCard");
    const guestCard = document.getElementById("guestCard");
    const openTestimonialModalBtn = document.getElementById("openTestimonialModal");
    const testimonialModal = document.getElementById("testimonialModal");
    const closeTestimonialModalBtn = document.getElementById("closeTestimonialModal");
    const form = document.getElementById("testimonialForm");
    const tAuthor = document.getElementById("tAuthor");
    const tEmail = document.getElementById("tEmail");
    const tRole = document.getElementById("tRole");
    const tQuote = document.getElementById("tQuote");
    const tMsg = document.getElementById("tMsg");
    const loginFromForm = document.getElementById("loginFromForm");
    const submitHint = document.getElementById("submitHint");
    const guestLoginBtn = document.getElementById("guestLoginBtn");
    const guestSignupBtn = document.getElementById("guestSignupBtn");

    function t(key, fallback) {
      return window.__dict?.[key] ?? fallback;
    }

    function localizeApiError(message) {
      if (!message) return "";
      const normalized = String(message).toLowerCase();
      if (normalized.includes("one testimonial") || normalized.includes("already submitted")) {
        return t("testimonials.msg.limitReached", "You can only submit one testimonial per account.");
      }
      if (normalized.includes("unauthorized") || normalized.includes("log in")) {
        return t("testimonials.msg.loginFirst", "Please log in first.");
      }
      return message;
    }

    function applyLocalizedPlaceholders() {
      tAuthor.placeholder = t("testimonials.form.namePlaceholder", "Your name");
      tRole.placeholder = t("testimonials.form.rolePlaceholder", "Your role");
      tQuote.placeholder = t("testimonials.form.quotePlaceholder", "Your testimonial (min 10 chars)");
    }

    function render(items) {
      itemsDiv.innerHTML = "";
      if (!items.length) {
        itemsDiv.innerHTML = `<p class="muted">${t("testimonials.empty", "No testimonials yet.")}</p>`;
        return;
      }
      for (const t of items) {
        const wrapper = document.createElement("div");
        wrapper.className = "card";
        wrapper.style.marginBottom = "0.75rem";
        wrapper.innerHTML = `
          <p style="margin:0"><strong>${t.author}</strong> ${t.role ? `— ${t.role}` : ""}</p>
          <p style="margin:0.25rem 0">“${t.quote}”</p>
        `;
        itemsDiv.appendChild(wrapper);
      }
    }

    function openTestimonialModal() {
      testimonialModal.hidden = false;
      setTimeout(() => tAuthor?.focus(), 0);
    }

    function closeTestimonialModal() {
      testimonialModal.hidden = true;
    }

    async function tryOpenTestimonialModal() {
      tMsg.textContent = "";
      try {
        const token = await window.__auth?.getAccessToken();
        if (!token) {
          tMsg.textContent = t("testimonials.msg.loginFirst", "Please log in first.");
          return;
        }

        const checkRes = await fetch(`${API}/can-submit`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!checkRes.ok) {
          const err = await checkRes.json().catch(() => ({}));
          throw new Error(err.error || err.message || `Failed (${checkRes.status})`);
        }

        const checkData = await checkRes.json();
        if (!checkData.allowed) {
          tMsg.textContent = localizeApiError(checkData.reason) || t("testimonials.msg.limitReached", "You can only submit one testimonial per account.");
          return;
        }

        openTestimonialModal();
      } catch (err) {
        console.error(err);
        tMsg.textContent = localizeApiError(err.message) || t("testimonials.msg.checkFailed", "Could not verify testimonial limit");
      }
    }

    async function load() {
      const res = await fetch(API);
      const items = await res.json();
      render(items);
      listCard.hidden = false;
    }

    load();

    // Auth gating for submission
    function updateSubmitVisibility(detail) {
      const authed = detail?.isAuthenticated;
      guestCard.hidden = !!authed;
      submitCard.hidden = !authed;
      loginFromForm.style.display = authed ? "none" : "inline-block";
      submitHint.textContent = authed ? "" : t("testimonials.submitHint", "Log in to submit a testimonial.");
      // Prefill from user profile if present
      if (authed && detail.user) {
        if (detail.user.name && !tAuthor.value) tAuthor.value = detail.user.name;
        if (detail.user.email) tEmail.value = detail.user.email;
      }
    }

    window.addEventListener("auth:change", (e) => updateSubmitVisibility(e.detail));
    setTimeout(() => {
      if (window.__auth) updateSubmitVisibility({
        isAuthenticated: window.__auth.isAuthenticated,
        user: window.__auth.user,
      });
    }, 100);

    loginFromForm.addEventListener("click", () => window.__auth?.login());
    guestLoginBtn?.addEventListener("click", () => window.__auth?.login());
    guestSignupBtn?.addEventListener("click", () => window.__auth?.signup());
    openTestimonialModalBtn?.addEventListener("click", tryOpenTestimonialModal);
    closeTestimonialModalBtn?.addEventListener("click", closeTestimonialModal);
    testimonialModal?.addEventListener("click", (e) => {
      if (e.target === testimonialModal) closeTestimonialModal();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      tMsg.textContent = "";
      try {
        const token = await window.__auth?.getAccessToken();
        if (!token) {
          tMsg.textContent = t("testimonials.msg.loginFirst", "Please log in first.");
          return;
        }
        const payload = { author: tAuthor.value.trim(), role: tRole.value.trim(), quote: tQuote.value.trim() };
        const res = await fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || err.message || `Failed (${res.status})`);
        }
        // Reload list and reset form
        await load();
        form.reset();
        closeTestimonialModal();
        if (window.__auth?.user?.email) tEmail.value = window.__auth.user.email;
        tMsg.textContent = t("testimonials.msg.pending", "Thanks! Your testimonial was submitted and is pending admin approval.");
      } catch (e) {
        console.error(e);
        tMsg.textContent = localizeApiError(e.message) || t("testimonials.msg.submitFailed", "Submit failed");
      }
    });

    document.addEventListener("i18n:change", async () => {
      applyLocalizedPlaceholders();
      updateSubmitVisibility({
        isAuthenticated: !!window.__auth?.isAuthenticated,
        user: window.__auth?.user,
      });
      await load();
    });

    setTimeout(() => {
      applyLocalizedPlaceholders();
    }, 110);
  </script>

  <style>
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: grid;
      place-items: center;
      z-index: 1000;
    }
    .modal-overlay[hidden] {
      display: none !important;
    }
    .modal-card {
      width: min(92vw, 560px);
      margin: 0;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
  </style>
</Layout>
