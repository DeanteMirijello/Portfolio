---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/nav.astro";
const API_BASE_VALUE = import.meta.env.PUBLIC_API_BASE || "http://localhost:3001";
---

<Layout>
  <Nav />

  <main data-api-base={API_BASE_VALUE}>
    <header class="page-header">
      <h1>Admin</h1>
    </header>

    <section class="admin-layout">
      <aside class="admin-sidebar">
        <button class="sidebar-btn" data-section="home">Home</button>
        <button class="sidebar-btn" data-section="about">About</button>
        <button class="sidebar-btn" data-section="projects">Projects</button>
        <button class="sidebar-btn" data-section="testimonials">Testimonials</button>
        <button class="sidebar-btn" data-section="contact">Contact</button>
        
      </aside>

      <div class="admin-content">
                <!-- Projects management -->
                <div id="section-projects" class="admin-section" hidden>
                  <h2>Projects</h2>
                  <div class="card" style="margin-top:.5rem;">
                    <form id="projectsForm" style="display:grid;gap:.75rem;">
                      <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;">
                        <select id="proj_id"></select>
                        <input id="proj_new_id" placeholder="new-project-id" style="display:none;" />
                      </div>
                      <div>
                        <label class="contact-label" for="proj_image">Image URL</label>
                        <input id="proj_image" placeholder="/assets/image1.png" />
                      </div>
                      <div style="display:grid;gap:.5rem;grid-template-columns:1fr 1fr;">
                        <div>
                          <h3 style="margin:.25rem 0;">English</h3>
                          <input id="proj_en_title" placeholder="Title" />
                          <input id="proj_en_date" placeholder="Date range" />
                          <textarea id="proj_en_desc" placeholder="Description" rows="3"></textarea>
                        </div>
                        <div>
                          <h3 style="margin:.25rem 0;">Français</h3>
                          <input id="proj_fr_title" placeholder="Titre" />
                          <input id="proj_fr_date" placeholder="Période" />
                          <textarea id="proj_fr_desc" placeholder="Description" rows="3"></textarea>
                        </div>
                      </div>
                      <div style="display:flex;gap:.5rem;justify-content:flex-end;">
                        <button type="submit" class="lang-btn">Save</button>
                      </div>
                      <p id="projectsMsg" class="muted" style="margin-top:.25rem;"></p>
                    </form>
                  </div>
                </div>
        <!-- Home management -->
        <div id="section-home" class="admin-section" hidden>
          <h2>Home</h2>
          <div class="card" style="margin-top:.5rem;">
            <form id="homeForm" style="display:grid;gap:.75rem;">
              <div>
                <label class="contact-label" for="home_image">Image URL (e.g., /assets/image1.png)</label>
                <input id="home_image" placeholder="/assets/image1.png" />
              </div>
              <div style="display:grid;gap:.5rem;grid-template-columns:1fr 1fr;">
                <div>
                  <h3 style="margin:.25rem 0;">English</h3>
                  <label class="contact-label" for="en_title">Title</label>
                  <input id="en_title" placeholder="Title" />
                  <label class="contact-label" for="en_subtitle">Description</label>
                  <textarea id="en_subtitle" placeholder="Description" rows="4"></textarea>
                  <label class="contact-label" for="en_li1">List item 1</label>
                  <input id="en_li1" placeholder="List item 1" />
                  <label class="contact-label" for="en_li2">List item 2</label>
                  <input id="en_li2" placeholder="List item 2" />
                  <label class="contact-label" for="en_li3">List item 3</label>
                  <input id="en_li3" placeholder="List item 3" />
                </div>
                <div>
                  <h3 style="margin:.25rem 0;">Français</h3>
                  <label class="contact-label" for="fr_title">Titre</label>
                  <input id="fr_title" placeholder="Titre" />
                  <label class="contact-label" for="fr_subtitle">Description</label>
                  <textarea id="fr_subtitle" placeholder="Description" rows="4"></textarea>
                  <label class="contact-label" for="fr_li1">Élément de liste 1</label>
                  <input id="fr_li1" placeholder="Élément de liste 1" />
                  <label class="contact-label" for="fr_li2">Élément de liste 2</label>
                  <input id="fr_li2" placeholder="Élément de liste 2" />
                  <label class="contact-label" for="fr_li3">Élément de liste 3</label>
                  <input id="fr_li3" placeholder="Élément de liste 3" />
                </div>
              </div>
              <div style="display:flex;gap:.5rem;justify-content:flex-end;">
                <button type="submit" class="lang-btn">Save</button>
              </div>
              <p id="homeMsg" class="muted" style="margin-top:.25rem;"></p>
            </form>
          </div>
        </div>
        <!-- Contact management -->
        <div id="section-contact" class="admin-section" hidden>
          <h2>Contact</h2>
          <div class="card" style="margin-top:.5rem;">
            <div style="display:flex;justify-content:flex-end;gap:.5rem;">
              <button type="button" id="contactAddBtn" class="lang-btn">Add</button>
            </div>
            <div id="contactItems" class="contact-card" style="margin-top:.75rem;"></div>
            <p id="adminContactMsg" class="muted" style="margin-top:.5rem;"></p>
          </div>
        </div>

        <!-- About management (consolidates Skills) -->
        <div id="section-about" class="admin-section" hidden>
          <h2>About</h2>
          <div class="card" style="margin-top:.5rem; display:grid; gap:.75rem;">
            <div style="display:flex; gap:.5rem; align-items:center; justify-content:flex-end;">
              <button type="button" id="about_type_add" class="lang-btn">Add Skill Type</button>
            </div>
            <div id="about_skills_list" style="display:grid; gap:.75rem;"></div>
            <p id="aboutMsg" class="muted" style="margin-top:.25rem;"></p>
          </div>
        </div>

        <!-- Testimonials management -->
        <div id="section-testimonials" class="admin-section" hidden>
          <h2>Testimonials</h2>
          <div class="card" style="margin-top:.5rem;">
            <form id="newTestimonialForm" style="display:grid;gap:.5rem;">
              <input id="t_author" placeholder="Author" />
              <textarea id="t_message" placeholder="Message" rows="3"></textarea>
              <div style="display:flex;gap:.5rem;justify-content:flex-end;">
                <button type="submit" class="lang-btn">Add</button>
              </div>
            </form>
          </div>

          <div id="testimonialsList" style="margin-top:1rem;display:grid;gap:.75rem;"></div>
        </div>

        
      </div>
    </section>
  </main>

  <script type="module">
    const API_BASE = document.querySelector("main").dataset.apiBase;

    // Sidebar switching
    const sections = {
      home: document.getElementById("section-home"),
      about: document.getElementById("section-about"),
      projects: document.getElementById("section-projects"),
      testimonials: document.getElementById("section-testimonials"),
      contact: document.getElementById("section-contact"),
    };
    const sidebarBtns = document.querySelectorAll(".sidebar-btn");
    function showSection(key) {
      Object.values(sections).forEach((el) => (el.hidden = true));
      sections[key].hidden = false;
      sidebarBtns.forEach((b) => b.classList.toggle("active", b.dataset.section === key));
    }
    // default to Home
    showSection("home");

    sidebarBtns.forEach((btn) => btn.addEventListener("click", () => showSection(btn.dataset.section)));

    // Contact Items API with modal add/edit per item
    const cMsg = document.getElementById("adminContactMsg");
    const contactItemsDiv = document.getElementById("contactItems");
    const contactAddBtn = document.getElementById("contactAddBtn");

    let contactItems = [];

    function renderContactItems() {
      contactItemsDiv.innerHTML = "";
      if (!contactItems.length) {
        contactItemsDiv.innerHTML = '<p class="muted">No contact items yet.</p>';
        return;
      }
      contactItems.forEach((item) => {
        const row = document.createElement("div");
        row.className = "contact-row";
        const label = document.createElement("span");
        label.className = "contact-label";
        label.textContent = item.title;
        const valueCell = document.createElement("div");
        const v = item.value || "";
        const isEmail = v.includes("@") && !/^https?:\/\//i.test(v);
        const isUrl = /^https?:\/\//i.test(v);
        if (isEmail || isUrl) {
          const a = document.createElement("a");
          a.className = "contact-link";
          a.href = isEmail ? `mailto:${v}` : v;
          a.target = "_blank";
          a.rel = "noreferrer";
          a.textContent = isEmail ? v : v.replace(/^https?:\/\//i, "");
          valueCell.appendChild(a);
        } else {
          const span = document.createElement("span");
          span.className = "contact-value";
          span.textContent = v;
          valueCell.appendChild(span);
        }
        const controls = document.createElement("div");
        controls.style.display = "inline-flex";
        controls.style.gap = ".5rem";
        controls.style.marginLeft = "1rem";
        const editBtn = document.createElement("button");
        editBtn.className = "lang-btn";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => openModal("contactItem", "edit", item));
        const delBtn = document.createElement("button");
        delBtn.className = "lang-btn";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", () => deleteContactItem(item.id));
        controls.appendChild(editBtn);
        controls.appendChild(delBtn);
        valueCell.appendChild(controls);
        row.appendChild(label);
        row.appendChild(valueCell);
        contactItemsDiv.appendChild(row);
      });
    }

    async function loadContactItems() {
      cMsg.textContent = "Loading...";
      try {
        const res = await fetch(`${API_BASE}/contact/items`);
        contactItems = await res.json();
        if (!contactItems.length) {
          const res2 = await fetch(`${API_BASE}/contact`);
          const base = await res2.json();
          const seedPairs = [
            ["Location", base.location],
            ["Email", base.email],
            ["GitHub", base.github],
            ["LinkedIn", base.linkedin],
          ];
          for (const [title, value] of seedPairs) {
            if (value) {
              await fetch(`${API_BASE}/contact/items`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title, value }),
              });
            }
          }
          const res3 = await fetch(`${API_BASE}/contact/items`);
          contactItems = await res3.json();
        }
        renderContactItems();
        cMsg.textContent = "";
      } catch (e) {
        console.error(e);
        cMsg.textContent = "Failed to load contact items.";
      }
    }

    // Shared Admin Modal (used for Contact and About/Skills)
    const modal = document.getElementById("adminModal");
    const modalTitle = document.getElementById("adminModalTitle");
    const modalForm = document.getElementById("adminModalForm");
    const mTitle = document.getElementById("modal_title");
    const mValue = document.getElementById("modal_value");
    const modalCancel = document.getElementById("adminModalCancel");
    const mEnTitle = document.getElementById("modal_en_title");
    const mFrTitle = document.getElementById("modal_fr_title");
    const modalDelete = document.getElementById("adminModalDelete");
    // Open add contact item modal
    contactAddBtn.addEventListener("click", () => openModal("contactItem", "add"));

    function openModal(context, mode, data) {
      modal.dataset.context = context;
      modal.dataset.mode = mode;
      modal.dataset.itemId = data?.id || "";
      modal.dataset.category = data?.category || "";
      modal.dataset.typeName = data?.name || "";
      if (context === "contactItem") {
        modalTitle.textContent = mode === "add" ? "Add Contact Item" : "Edit Contact Item";
        mTitle.style.display = "block";
        mValue.style.display = "block";
        mEnTitle.style.display = "none";
        mFrTitle.style.display = "none";
        modalDelete.style.display = "none";
        mTitle.value = data?.title || "";
        mValue.value = data?.value || "";
      } else if (context === "skillType") {
        modalTitle.textContent = mode === "add" ? "Add Skill Type" : "Edit Skill Type";
        mTitle.style.display = "none";
        mValue.style.display = "none";
        mEnTitle.style.display = "block";
        mFrTitle.style.display = "block";
        modalDelete.style.display = mode === "edit" ? "inline-block" : "none";
        // Prefill titles if available (edit)
        const baseName = data?.name;
        const t = window.__skillsTitles?.[baseName] || { en: baseName || "", fr: baseName || "" };
        mEnTitle.value = t.en || "";
        mFrTitle.value = t.fr || "";
      } else if (context === "skillItem") {
        modalTitle.textContent = mode === "add" ? "Add Skill" : "Edit Skill";
        mTitle.style.display = "none";
        mValue.style.display = "block";
        mEnTitle.style.display = "none";
        mFrTitle.style.display = "none";
        modalDelete.style.display = mode === "edit" ? "inline-block" : "none";
        mTitle.value = "";
        mValue.value = data?.value || "";
      }
      modal.hidden = false;
    }

    function closeModal() {
      modal.hidden = true;
      modal.dataset.context = "";
      modal.dataset.mode = "";
      modal.dataset.itemId = "";
      // Clear messages
      if (typeof cMsg !== "undefined") cMsg.textContent = "";
      if (typeof aboutMsg !== "undefined") aboutMsg.textContent = "";
    }

    modalCancel.addEventListener("click", closeModal);

    modalForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const context = modal.dataset.context;
      const mode = modal.dataset.mode;
      try {
        if (context === "contactItem") {
          cMsg.textContent = "Saving...";
          const payload = { title: mTitle.value.trim(), value: mValue.value.trim() };
          const itemId = modal.dataset.itemId;
          const url = mode === "edit" ? `${API_BASE}/contact/items/${itemId}` : `${API_BASE}/contact/items`;
          const method = mode === "edit" ? "PUT" : "POST";
          const res = await fetch(url, { method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
          const data = await res.json();
          if (!res.ok) { cMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          closeModal();
          await loadContactItems();
          cMsg.textContent = "Saved.";
        } else if (context === "skillType") {
          aboutMsg.textContent = "Saving...";
          const selected = modal.dataset.typeName;
          if (mode === "add") {
            // Create type key from English title (simple slug)
            const en = mEnTitle.value.trim();
            const fr = mFrTitle.value.trim();
            const name = en.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "") || en;
            const res = await fetch(`${API_BASE}/skills/types`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
            const res2 = await fetch(`${API_BASE}/skills/types/${encodeURIComponent(name)}/titles`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ en, fr }) });
            const data2 = await res2.json();
            if (!res2.ok) { aboutMsg.textContent = (data2.errors?.[0]?.msg) || data2.error || "Save failed"; return; }
          } else {
            // Save bilingual titles for the selected type
            const res = await fetch(`${API_BASE}/skills/types/${encodeURIComponent(selected)}/titles`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ en: mEnTitle.value.trim(), fr: mFrTitle.value.trim() }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          }
          closeModal();
          await loadAboutSkills();
          aboutMsg.textContent = "Saved.";
        } else if (context === "skillItem") {
          aboutMsg.textContent = "Saving...";
          const category = modal.dataset.category;
          const value = mValue.value.trim();
          if (mode === "add") {
            const res = await fetch(`${API_BASE}/skills/items`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ category, value }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          } else {
            const oldValue = modal.dataset.itemId;
            const res = await fetch(`${API_BASE}/skills/items`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ category, oldValue, newValue: value }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          }
          closeModal();
          await loadAboutSkills();
          aboutMsg.textContent = "Saved.";
        }
      } catch (err) {
        console.error(err);
        if (context === "contactItem") cMsg.textContent = "Network error";
        else aboutMsg.textContent = "Network error";
      }
    });

    // Modal delete actions (skillType edit, skillItem edit)
    modalDelete.addEventListener("click", async () => {
      const context = modal.dataset.context;
      try {
        if (context === "skillType") {
          const name = modal.dataset.typeName || (mEnTitle.value.trim().toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "") || mEnTitle.value.trim());
          if (!confirm("Delete this type and all its skills?")) return;
          const res = await fetch(`${API_BASE}/skills/types/${encodeURIComponent(name)}`, { method: "DELETE" });
          if (res.ok) { closeModal(); loadAboutSkills(); }
        } else if (context === "skillItem") {
          const category = modal.dataset.category;
          const oldValue = modal.dataset.itemId;
          if (!confirm("Delete this skill?")) return;
          const res = await fetch(`${API_BASE}/skills/items`, { method: "DELETE", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ category, value: oldValue }) });
          if (res.ok) { closeModal(); loadAboutSkills(); }
        }
      } catch (e) { console.error(e); }
    });

    async function deleteContactItem(id) {
      if (!confirm("Delete this contact item?")) return;
      try {
        const res = await fetch(`${API_BASE}/contact/items/${id}`, { method: "DELETE" });
        if (res.ok) {
          await loadContactItems();
        }
      } catch (e) {
        console.error(e);
      }
    }

    // Testimonials API
    const tList = document.getElementById("testimonialsList");
    const tForm = document.getElementById("newTestimonialForm");
    const tAuthor = document.getElementById("t_author");
    const tMessage = document.getElementById("t_message");

    async function renderTestimonials() {
      tList.innerHTML = "Loading...";
      try {
        const res = await fetch(`${API_BASE}/testimonials`);
        const items = await res.json();
        tList.innerHTML = "";
        items.forEach((t) => {
          const card = document.createElement("div");
          card.className = "card";
          card.style.padding = "0.75rem";
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;">
              <strong>${t.author}</strong>
              <div style="display:flex;gap:.5rem;">
                <button class="lang-btn" data-edit="${t.id}">Edit</button>
                <button class="lang-btn" data-del="${t.id}">Delete</button>
              </div>
            </div>
            <p style="margin:.5rem 0 0">${t.message}</p>
          `;
          const editBtn = card.querySelector(`[data-edit="${t.id}"]`);
          const delBtn = card.querySelector(`[data-del="${t.id}"]`);
          editBtn.addEventListener("click", () => editTestimonial(t));
          delBtn.addEventListener("click", () => deleteTestimonial(t.id));
          tList.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        tList.textContent = "Failed to load testimonials.";
      }
    }

    tForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = { author: tAuthor.value.trim(), message: tMessage.value.trim() };
      if (!payload.author || !payload.message) return;
      try {
        const res = await fetch(`${API_BASE}/testimonials`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (res.ok) {
          tAuthor.value = "";
          tMessage.value = "";
          renderTestimonials();
        }
      } catch (e) {
        console.error(e);
      }
    });

    async function editTestimonial(item) {
      const newAuthor = prompt("Edit author", item.author);
      if (newAuthor === null) return;
      const newMessage = prompt("Edit message", item.message);
      if (newMessage === null) return;
      try {
        await fetch(`${API_BASE}/testimonials/${item.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ author: newAuthor, message: newMessage }),
        });
        renderTestimonials();
      } catch (e) {
        console.error(e);
      }
    }

    async function deleteTestimonial(id) {
      if (!confirm("Delete this testimonial?")) return;
      try {
        await fetch(`${API_BASE}/testimonials/${id}`, { method: "DELETE" });
        renderTestimonials();
      } catch (e) {
        console.error(e);
      }
    }

    // About/Skills management
    const aboutTypeAddBtn = document.getElementById("about_type_add");
    const aboutTypeRenameBtn = document.getElementById("about_type_rename");
    const aboutTypeDeleteBtn = document.getElementById("about_type_delete");
    const aboutSkillsList = document.getElementById("about_skills_list");
    const aboutMsg = document.getElementById("aboutMsg");

    let skillsData = {};

    async function loadAboutSkills() {
      aboutSkillsList.innerHTML = "Loading...";
      try {
        const [skillsRes, titlesRes] = await Promise.all([
          fetch(`${API_BASE}/skills`),
          fetch(`${API_BASE}/skills/titles`),
        ]);
        skillsData = await skillsRes.json();
        window.__skillsTitles = await titlesRes.json();
        renderAboutSkills();
        aboutMsg.textContent = "";
      } catch (e) {
        console.error(e);
        aboutSkillsList.textContent = "Failed to load skills.";
      }
    }

    function renderAboutSkills() {
      aboutSkillsList.innerHTML = "";
      Object.entries(skillsData).forEach(([cat, arr]) => {
        const block = document.createElement("div");
        block.className = "card";
        const header = document.createElement("div");
        header.style.display = "flex";
        header.style.alignItems = "center";
        header.style.justifyContent = "space-between";
        const titleEl = document.createElement("h3");
        titleEl.style.marginTop = "0";
        titleEl.style.textTransform = "capitalize";
        titleEl.textContent = (window.__skillsTitles?.[cat]?.en || cat);
        const subtitleEl = document.createElement("p");
        subtitleEl.className = "muted";
        subtitleEl.style.margin = "0";
        subtitleEl.textContent = window.__skillsTitles?.[cat]?.fr ? `FR: ${window.__skillsTitles[cat].fr}` : "";
        const titleWrap = document.createElement("div");
        titleWrap.appendChild(titleEl);
        if (subtitleEl.textContent) titleWrap.appendChild(subtitleEl);
        const actions = document.createElement("div");
        actions.style.display = "inline-flex";
        actions.style.gap = ".5rem";
        const editTypeBtn = document.createElement("button");
        editTypeBtn.className = "lang-btn";
        editTypeBtn.textContent = "Edit Type";
        editTypeBtn.addEventListener("click", () => openModal("skillType", "edit", { name: cat }));
        const addSkillBtn = document.createElement("button");
        addSkillBtn.className = "lang-btn";
        addSkillBtn.textContent = "Add Skill";
        addSkillBtn.addEventListener("click", () => openModal("skillItem", "add", { category: cat }));
        actions.appendChild(editTypeBtn);
        actions.appendChild(addSkillBtn);
        header.appendChild(titleWrap);
        header.appendChild(actions);
        block.appendChild(header);
        const tags = document.createElement("div");
        tags.className = "tags";
        arr.forEach((val) => {
          const tag = document.createElement("span");
          tag.className = "tag";
          tag.textContent = val;
          tag.style.cursor = "pointer";
          tag.title = "Click to edit";
          tag.addEventListener("click", () => openModal("skillItem", "edit", { id: val, value: val, category: cat }));
          tags.appendChild(tag);
        });
        block.appendChild(tags);
        aboutSkillsList.appendChild(block);
      });
    }
    aboutTypeAddBtn.addEventListener("click", () => openModal("skillType", "add"));

    // Initial loads
    // Home
    const hForm = document.getElementById("homeForm");
    const hMsg = document.getElementById("homeMsg");
    const hInputs = {
      image: document.getElementById("home_image"),
      en: {
        title: document.getElementById("en_title"),
        subtitle: document.getElementById("en_subtitle"),
        li1: document.getElementById("en_li1"),
        li2: document.getElementById("en_li2"),
        li3: document.getElementById("en_li3"),
      },
      fr: {
        title: document.getElementById("fr_title"),
        subtitle: document.getElementById("fr_subtitle"),
        li1: document.getElementById("fr_li1"),
        li2: document.getElementById("fr_li2"),
        li3: document.getElementById("fr_li3"),
      },
    };

    async function loadHome() {
      try {
        const res = await fetch(`${API_BASE}/home`);
        const data = await res.json();
        hInputs.image.value = data.image || "";
        hInputs.en.title.value = data.en?.title || "";
        hInputs.en.subtitle.value = data.en?.subtitle || "";
        hInputs.en.li1.value = data.en?.li1 || "";
        hInputs.en.li2.value = data.en?.li2 || "";
        hInputs.en.li3.value = data.en?.li3 || "";
        hInputs.fr.title.value = data.fr?.title || "";
        hInputs.fr.subtitle.value = data.fr?.subtitle || "";
        hInputs.fr.li1.value = data.fr?.li1 || "";
        hInputs.fr.li2.value = data.fr?.li2 || "";
        hInputs.fr.li3.value = data.fr?.li3 || "";
      } catch (e) {
        console.error(e);
        hMsg.textContent = "Failed to load home content.";
      }
    }

    hForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hMsg.textContent = "Saving...";
      const payload = {
        image: hInputs.image.value.trim(),
        en: {
          title: hInputs.en.title.value.trim(),
          subtitle: hInputs.en.subtitle.value.trim(),
          li1: hInputs.en.li1.value.trim(),
          li2: hInputs.en.li2.value.trim(),
          li3: hInputs.en.li3.value.trim(),
        },
        fr: {
          title: hInputs.fr.title.value.trim(),
          subtitle: hInputs.fr.subtitle.value.trim(),
          li1: hInputs.fr.li1.value.trim(),
          li2: hInputs.fr.li2.value.trim(),
          li3: hInputs.fr.li3.value.trim(),
        },
      };
      try {
        const res = await fetch(`${API_BASE}/home`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) {
          hMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed";
          return;
        }
        hMsg.textContent = "Saved.";
      } catch (e) {
        console.error(e);
        hMsg.textContent = "Network error";
      }
    });

    // Projects
    const pForm = document.getElementById("projectsForm");
    const pMsg = document.getElementById("projectsMsg");
    const pId = document.getElementById("proj_id");
    const pInputs = {
      image: document.getElementById("proj_image"),
      en: {
        title: document.getElementById("proj_en_title"),
        date: document.getElementById("proj_en_date"),
        desc: document.getElementById("proj_en_desc"),
      },
      fr: {
        title: document.getElementById("proj_fr_title"),
        date: document.getElementById("proj_fr_date"),
        desc: document.getElementById("proj_fr_desc"),
      },
    };

    async function loadProject(id) {
      try {
        const res = await fetch(`${API_BASE}/projects/${id}`);
        const data = await res.json();
        pInputs.image.value = data.image || "";
        pInputs.en.title.value = data.en?.title || "";
        pInputs.en.date.value = data.en?.date || "";
        pInputs.en.desc.value = data.en?.desc || "";
        pInputs.fr.title.value = data.fr?.title || "";
        pInputs.fr.date.value = data.fr?.date || "";
        pInputs.fr.desc.value = data.fr?.desc || "";
      } catch (e) {
        console.error(e);
        pMsg.textContent = "Failed to load project.";
      }
    }

    pId.addEventListener("change", () => {
      const val = pId.value;
      const isNew = val === "__new__";
      document.getElementById("proj_new_id").style.display = isNew ? "inline-block" : "none";
      if (!isNew) loadProject(val);
      else {
        // Reset fields for new project
        pInputs.image.value = "";
        pInputs.en.title.value = "";
        pInputs.en.date.value = "";
        pInputs.en.desc.value = "";
        pInputs.fr.title.value = "";
        pInputs.fr.date.value = "";
        pInputs.fr.desc.value = "";
      }
    });

    pForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      pMsg.textContent = "Saving...";
      const payload = {
        image: pInputs.image.value.trim(),
        en: {
          title: pInputs.en.title.value.trim(),
          date: pInputs.en.date.value.trim(),
          desc: pInputs.en.desc.value.trim(),
        },
        fr: {
          title: pInputs.fr.title.value.trim(),
          date: pInputs.fr.date.value.trim(),
          desc: pInputs.fr.desc.value.trim(),
        },
      };
      try {
        const isNew = pId.value === "__new__";
        const idForNew = document.getElementById("proj_new_id").value.trim();
        const res = await fetch(isNew ? `${API_BASE}/projects` : `${API_BASE}/projects/${pId.value}`, {
          method: isNew ? "POST" : "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(isNew ? { id: idForNew, ...payload } : payload),
        });
        const data = await res.json();
        if (!res.ok) {
          pMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed";
          return;
        }
        pMsg.textContent = "Saved.";
        await loadProjectsList();
        if (isNew && idForNew) {
          pId.value = idForNew;
        }
      } catch (e) {
        console.error(e);
        pMsg.textContent = "Network error";
      }
    });

    async function loadProjectsList() {
      try {
        const res = await fetch(`${API_BASE}/projects`);
        const data = await res.json();
        pId.innerHTML = "";
        // Add existing projects
        Object.entries(data).forEach(([id, entry]) => {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = entry.en?.title || id;
          pId.appendChild(opt);
        });
        // Add New option
        const newOpt = document.createElement("option");
        newOpt.value = "__new__";
        newOpt.textContent = "New…";
        pId.appendChild(newOpt);
      } catch (e) {
        console.error(e);
      }
    }

    loadHome();
    await loadProjectsList();
    pId.value = pId.options[0]?.value || "__new__";
    if (pId.value !== "__new__") loadProject(pId.value);
    loadContactItems();
    renderTestimonials();
    loadAboutSkills();
  </script>

  <!-- Admin Modal (shared; currently used for Contact Items) -->
  <div id="adminModal" class="modal-overlay" hidden>
    <div class="modal">
      <h3 id="adminModalTitle" style="margin-top:0;">Edit</h3>
      <form id="adminModalForm" style="display:grid;gap:.5rem;">
        <input id="modal_title" placeholder="Title" />
        <input id="modal_value" placeholder="Value" />
        <input id="modal_en_title" placeholder="English title" style="display:none;" />
        <input id="modal_fr_title" placeholder="French title" style="display:none;" />
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem;">
          <button type="button" id="adminModalDelete" class="lang-btn" style="margin-right:auto;display:none;">Delete</button>
          <button type="button" id="adminModalCancel" class="lang-btn">Cancel</button>
          <button type="submit" class="lang-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: grid; place-items: center; z-index: 1000; }
    .modal-overlay[hidden] { display: none !important; }
    .modal { background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 1rem; border-radius: 12px; width: min(520px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .modal input, .modal textarea, .modal select { width: 100%; padding: 0.6rem 0.75rem; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); font: inherit; transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease; }
    .modal input::placeholder, .modal textarea::placeholder { color: var(--muted); opacity: 0.85; }
    .modal input:focus, .modal textarea:focus, .modal select:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 3px rgba(50, 69, 255, 0.2); }
  </style>
</Layout>
