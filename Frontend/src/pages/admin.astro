---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/nav.astro";
const API_BASE_VALUE = import.meta.env.PUBLIC_API_BASE || "http://localhost:3001";
---

<Layout>
  <Nav />

  <section id="adminGuard" class="contact-card" style="max-width:720px; margin:1rem auto;" hidden>
    <h2 style="margin-top:0" data-i18n="admin.guard.title">Admin Area</h2>
    <p class="muted" data-i18n="admin.guard.subtitle">Please log in with an admin account to manage content.</p>
    <button type="button" id="adminLoginBtn" data-i18n="auth.login">Log in</button>
  </section>

  <main id="adminApp" data-api-base={API_BASE_VALUE} hidden>

    <section class="admin-layout">
      <aside class="admin-sidebar">
        <button class="sidebar-btn" data-section="home" data-i18n="nav.home">Home</button>
        <button class="sidebar-btn" data-section="about" data-i18n="nav.about">About</button>
        <button class="sidebar-btn" data-section="skills" data-i18n="nav.skills">Skills</button>
        <button class="sidebar-btn" data-section="projects" data-i18n="nav.projects">Projects</button>
        <button class="sidebar-btn" data-section="contact" data-i18n="nav.contact">Contact</button>
        <button class="sidebar-btn" data-section="testimonials" data-i18n="nav.testimonials">Testimonials</button>
        
      </aside>

      <div class="admin-content">
                <!-- Projects management -->
                <div id="section-projects" class="admin-section" hidden>
                  <h2 data-i18n="projects.title">Projects</h2>
                  <div class="card" style="margin-top:.5rem;">
                    <div style="display:grid;gap:.5rem;">
                      <button type="button" id="projectAddBtn" class="lang-btn" style="justify-self:start;">Add Project</button>
                      <div class="skills-admin-head" style="display:grid;grid-template-columns:1fr 2fr 1.2fr auto;gap:.5rem;font-weight:600;">
                        <span>ID</span>
                        <span>Title</span>
                        <span>Date</span>
                        <span>Action</span>
                      </div>
                    </div>
                    <div id="projectsList" style="display:grid;gap:.75rem;margin-top:.75rem;"></div>
                    <p id="projectsMsg" class="muted" style="margin-top:.25rem;"></p>
                  </div>
                </div>
        <!-- Home management -->
        <div id="section-home" class="admin-section" hidden>
          <h2 data-i18n="nav.home">Home</h2>
          <div class="card admin-home-card" style="margin-top:.5rem;">
            <div class="admin-home-top">
              <img id="homePreview" alt="Home image" src="" class="admin-home-image" />
              <div class="admin-home-image-meta">
                <span class="muted" id="homeImageUrl">/assets/image1.png</span>
                <div>
                  <button type="button" class="lang-btn" id="homeEditImage" data-i18n="admin.home.editImage">Edit Image</button>
                  <input id="homeImageFile" type="file" accept="image/*" style="display:none;" />
                </div>
              </div>
            </div>
            <div class="admin-home-columns">
              <div class="admin-home-col">
                <h3 style="margin:.25rem 0;">English</h3>
                <p style="margin:.25rem 0;"><strong>Title:</strong> <span id="homeTitleEn"></span></p>
                <p style="margin:.25rem 0;"><strong>Description:</strong><br /><span id="homeSubtitleEn" class="muted"></span></p>
                <p style="margin:.25rem 0;"><strong>Currently working on:</strong> <span id="homeCurrentEn" class="muted"></span></p>
                <div class="admin-home-actions">
                  <button type="button" class="lang-btn" id="homeEditTitle" data-i18n="admin.home.editTitle">Edit Title</button>
                  <button type="button" class="lang-btn" id="homeEditSubtitle" data-i18n="admin.home.editDescription">Edit Description</button>
                  <button type="button" class="lang-btn" id="homeEditCurrent" data-i18n="admin.home.editCurrent">Edit Current</button>
                </div>
              </div>
              <div class="admin-home-col">
                <h3 style="margin:.25rem 0;">Français</h3>
                <p style="margin:.25rem 0;"><strong>Titre:</strong> <span id="homeTitleFr"></span></p>
                <p style="margin:.25rem 0;"><strong>Description:</strong><br /><span id="homeSubtitleFr" class="muted"></span></p>
                <p style="margin:.25rem 0;"><strong>En cours:</strong> <span id="homeCurrentFr" class="muted"></span></p>
              </div>
            </div>
            <p id="homeMsg" class="muted" style="margin-top:.25rem;"></p>
          </div>
        </div>
        <!-- About management (now includes Contact editing) -->
        <div id="section-about" class="admin-section" hidden>
          <h2 data-i18n="nav.about">About</h2>
          <div style="display:flex; gap:.5rem; align-items:center; margin-top:.5rem;">
            <label for="aboutEditSelect" class="contact-label" data-i18n="admin.about.editSection">Edit section</label>
            <select id="aboutEditSelect" style="width:220px;">
              <option value="work" selected data-i18n="about.workTitle">Work Experience</option>
              <option value="school" data-i18n="about.schoolTitle">School Experience</option>
            </select>
          </div>
          <!-- Work Experience editing -->
          <div id="aboutWorkCard" class="card" style="margin-top:.5rem; display:grid; gap:.5rem;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <h3 style="margin:0;" data-i18n="about.workTitle">Work Experience</h3>
              <div style="display:inline-flex; gap:.5rem;">
                <button type="button" id="workEditEnBtn" class="lang-btn" data-i18n="admin.common.editEn">Edit EN</button>
                <button type="button" id="workEditFrBtn" class="lang-btn" data-i18n="admin.common.editFr">Edit FR</button>
              </div>
            </div>
            <div style="display:grid; gap:.25rem; grid-template-columns:1fr 1fr;">
              <div>
                <p style="margin:.25rem 0;"><strong>Company:</strong> <span id="workCompany"></span></p>
                <p style="margin:.25rem 0;"><strong>Role (EN):</strong> <span id="workRoleEn" class="muted"></span></p>
                <p style="margin:.25rem 0;"><strong>Date (EN):</strong> <span id="workDateEn" class="muted"></span></p>
                <div>
                  <strong>Bullets (EN):</strong>
                  <ul id="workBulletsEn" class="clean-list" style="margin:.25rem 0 0;"></ul>
                </div>
              </div>
              <div>
                <p style="margin:.25rem 0;"><strong>Rôle (FR):</strong> <span id="workRoleFr" class="muted"></span></p>
                <p style="margin:.25rem 0;"><strong>Période (FR):</strong> <span id="workDateFr" class="muted"></span></p>
                <div>
                  <strong>Puces (FR):</strong>
                  <ul id="workBulletsFr" class="clean-list" style="margin:.25rem 0 0;"></ul>
                </div>
              </div>
            </div>
            <p id="workMsg" class="muted" style="margin-top:.25rem;"></p>
          </div>
          <!-- School Experience editing -->
          <div id="aboutSchoolCard" class="card" style="margin-top:.5rem; display:grid; gap:.5rem;" hidden>
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <h3 style="margin:0;" data-i18n="about.schoolTitle">School Experience</h3>
              <div style="display:inline-flex; gap:.5rem;">
                <button type="button" id="schoolEditEnBtn" class="lang-btn" data-i18n="admin.common.editEn">Edit EN</button>
                <button type="button" id="schoolEditFrBtn" class="lang-btn" data-i18n="admin.common.editFr">Edit FR</button>
              </div>
            </div>
            <div style="display:grid; gap:.25rem; grid-template-columns:1fr 1fr;">
              <div>
                <p style="margin:.25rem 0;"><strong>Program (EN):</strong> <span id="schoolProgramEn" class="muted"></span></p>
                <p style="margin:.25rem 0;"><strong>Date (EN):</strong> <span id="schoolDateEn" class="muted"></span></p>
                <div>
                  <strong>Bullets (EN):</strong>
                  <ul id="schoolBulletsEn" class="clean-list" style="margin:.25rem 0 0;"></ul>
                </div>
              </div>
              <div>
                <p style="margin:.25rem 0;"><strong>Programme (FR):</strong> <span id="schoolProgramFr" class="muted"></span></p>
                <p style="margin:.25rem 0;"><strong>Période (FR):</strong> <span id="schoolDateFr" class="muted"></span></p>
                <div>
                  <strong>Puces (FR):</strong>
                  <ul id="schoolBulletsFr" class="clean-list" style="margin:.25rem 0 0;"></ul>
                </div>
              </div>
            </div>
            <p id="schoolMsg" class="muted" style="margin-top:.25rem;"></p>
          </div>
        </div>

        <!-- Contact messages management -->
        <div id="section-contact" class="admin-section" hidden>
          <h2 data-i18n="nav.contact">Contact</h2>
          <div class="card" style="margin-top:.5rem; display:grid; gap:.75rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:.5rem;">
              <p class="muted" style="margin:0;" data-i18n="admin.contact.messagesHelp">Messages sent from the Contact page.</p>
              <button type="button" id="contactMessagesRefresh" class="lang-btn" data-i18n="admin.common.refresh">Refresh</button>
            </div>
            <div id="contactMessagesList" class="contact-card"></div>
            <p id="contactMessagesMsg" class="muted" style="margin-top:.25rem;"></p>
          </div>
        </div>

        <!-- Skills management (moved out of About) -->
        <div id="section-skills" class="admin-section" hidden>
          <h2 data-i18n="skills.title">Skills</h2>
          <div class="card" style="margin-top:.5rem; display:grid; gap:.75rem;">
            <div style="display:grid;gap:.5rem;">
              <button type="button" id="skillAddBtn" class="lang-btn" style="justify-self:start;">Add Skill</button>
              <div class="skills-admin-head" style="display:grid;grid-template-columns:2fr 1.5fr .8fr auto;gap:.5rem;font-weight:600;">
                <span>Title</span>
                <span>Type</span>
                <span>Rating</span>
                <span>Action</span>
              </div>
            </div>
            <div id="about_skills_list" style="display:grid; gap:.75rem;"></div>
            <p id="aboutMsg" class="muted" style="margin-top:.25rem;"></p>
          </div>
        </div>

        <!-- Testimonials management -->
        <div id="section-testimonials" class="admin-section" hidden>
          <h2 data-i18n="testimonials.title">Testimonials</h2>
          <div class="card" style="margin-top:.5rem;">
            <p class="muted" style="margin:0;" data-i18n="admin.testimonials.help">Approve pending testimonials before they appear publicly.</p>
          </div>

          <div id="testimonialsList" style="margin-top:1rem;display:grid;gap:.75rem;"></div>
        </div>

        
      </div>
    </section>
  </main>

  <script type="module">
    const API_BASE = (() => {
      const envBase = document.querySelector("main").dataset.apiBase;
      const host = location.hostname;
      if (host === "localhost" || host === "127.0.0.1") return "http://localhost:3001";
      return envBase;
    })();

    function t(key, fallback) {
      return window.__dict?.[key] ?? fallback;
    }

    // Auth guard: only allow admins to view main content
    const appEl = document.getElementById("adminApp");
    const guardEl = document.getElementById("adminGuard");
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    adminLoginBtn?.addEventListener("click", () => window.__auth?.login());

    function updateAdminGuard(detail) {
      const isAdmin = !!detail?.isAdmin;
      if (isAdmin) {
        appEl.hidden = false;
        guardEl.hidden = true;
      } else {
        appEl.hidden = true;
        guardEl.hidden = false;
      }
    }
    window.addEventListener("auth:change", (e) => updateAdminGuard(e.detail));
    setTimeout(() => {
      if (window.__auth) updateAdminGuard({ isAdmin: window.__auth.isAdmin });
    }, 100);

    // Sidebar switching
    const sections = {
      home: document.getElementById("section-home"),
      about: document.getElementById("section-about"),
      contact: document.getElementById("section-contact"),
      skills: document.getElementById("section-skills"),
      projects: document.getElementById("section-projects"),
      testimonials: document.getElementById("section-testimonials"),
    };
    const sidebarBtns = document.querySelectorAll(".sidebar-btn");
    function showSection(key) {
      Object.values(sections).forEach((el) => (el.hidden = true));
      sections[key].hidden = false;
      sidebarBtns.forEach((b) => b.classList.toggle("active", b.dataset.section === key));
      if (key === "contact") loadContactMessages();
    }
    // default to Home
    showSection("home");

    sidebarBtns.forEach((btn) => btn.addEventListener("click", () => showSection(btn.dataset.section)));

    // Contact Items API with modal add/edit per item
    const cMsg = document.getElementById("adminContactMsg");
    const contactItemsDiv = document.getElementById("contactItems");
    const contactAddBtn = document.getElementById("contactAddBtn");
    const contactMessagesList = document.getElementById("contactMessagesList");
    const contactMessagesMsg = document.getElementById("contactMessagesMsg");
    const contactMessagesRefresh = document.getElementById("contactMessagesRefresh");

    let contactItems = [];
    // Expose home data globally for modal prefill
    window.__homeData = null;
    window.__workData = null;
    window.__schoolData = null;

    // Work Experience
    const workCompanyEl = document.getElementById("workCompany");
    const workRoleEnEl = document.getElementById("workRoleEn");
    const workDateEnEl = document.getElementById("workDateEn");
    const workBulletsEnEl = document.getElementById("workBulletsEn");
    const workRoleFrEl = document.getElementById("workRoleFr");
    const workDateFrEl = document.getElementById("workDateFr");
    const workBulletsFrEl = document.getElementById("workBulletsFr");
    const workEditBtn = document.getElementById("workEditBtn");
    const workMsg = document.getElementById("workMsg");
    const schoolProgramEnEl = document.getElementById("schoolProgramEn");
    const schoolDateEnEl = document.getElementById("schoolDateEn");
    const schoolBulletsEnEl = document.getElementById("schoolBulletsEn");
    const schoolProgramFrEl = document.getElementById("schoolProgramFr");
    const schoolDateFrEl = document.getElementById("schoolDateFr");
    const schoolBulletsFrEl = document.getElementById("schoolBulletsFr");
    const schoolMsg = document.getElementById("schoolMsg");

    async function loadWork() {
      workMsg.textContent = "Loading...";
      try {
        const res = await fetch(`${API_BASE}/about/work`);
        window.__workData = await res.json();
        workCompanyEl.textContent = window.__workData.company || "";
        workRoleEnEl.textContent = window.__workData.en?.role || "";
        workDateEnEl.textContent = window.__workData.en?.date || "";
        workBulletsEnEl.innerHTML = "";
        (window.__workData.en?.bullets || []).forEach((b) => {
          const li = document.createElement("li");
          li.textContent = b;
          workBulletsEnEl.appendChild(li);
        });
        workRoleFrEl.textContent = window.__workData.fr?.role || "";
        workDateFrEl.textContent = window.__workData.fr?.date || "";
        workBulletsFrEl.innerHTML = "";
        (window.__workData.fr?.bullets || []).forEach((b) => {
          const li = document.createElement("li");
          li.textContent = b;
          workBulletsFrEl.appendChild(li);
        });
        workMsg.textContent = "";
      } catch (e) {
        console.error(e);
        workMsg.textContent = "Failed to load work experience.";
      }
    }

    async function loadSchool() {
      schoolMsg.textContent = "Loading...";
      try {
        const res = await fetch(`${API_BASE}/about/school`);
        window.__schoolData = await res.json();
        schoolProgramEnEl.textContent = window.__schoolData.en?.program || "";
        schoolDateEnEl.textContent = window.__schoolData.en?.date || "";
        schoolBulletsEnEl.innerHTML = "";
        (window.__schoolData.en?.bullets || []).forEach((b) => {
          const li = document.createElement("li");
          li.textContent = b;
          schoolBulletsEnEl.appendChild(li);
        });
        schoolProgramFrEl.textContent = window.__schoolData.fr?.program || "";
        schoolDateFrEl.textContent = window.__schoolData.fr?.date || "";
        schoolBulletsFrEl.innerHTML = "";
        (window.__schoolData.fr?.bullets || []).forEach((b) => {
          const li = document.createElement("li");
          li.textContent = b;
          schoolBulletsFrEl.appendChild(li);
        });
        schoolMsg.textContent = "";
      } catch (e) {
        console.error(e);
        schoolMsg.textContent = "Failed to load school experience.";
      }
    }

    function renderContactItems() {
      if (!contactItemsDiv) return;
      contactItemsDiv.innerHTML = "";
      if (!contactItems.length) {
        contactItemsDiv.innerHTML = '<p class="muted">No contact items yet.</p>';
        return;
      }
      contactItems.forEach((item) => {
        const row = document.createElement("div");
        row.className = "contact-row";
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.justifyContent = "space-between";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "1rem";

        const label = document.createElement("span");
        label.className = "contact-label";
        const lang = window.__lang || "en";
        label.textContent = (lang === "fr" ? item.titleFr : item.titleEn) || item.title || "";

        const valueCell = document.createElement("div");
        const v = item.value || "";
        const isEmail = v.includes("@") && !/^https?:\/\//i.test(v);
        const isUrl = /^https?:\/\//i.test(v);
        if (isEmail || isUrl) {
          const a = document.createElement("a");
          a.className = "contact-link";
          a.href = isEmail ? `mailto:${v}` : v;
          a.target = "_blank";
          a.rel = "noreferrer";
          a.textContent = isEmail ? v : v.replace(/^https?:\/\//i, "");
          valueCell.appendChild(a);
        } else {
          const span = document.createElement("span");
          span.className = "contact-value";
          span.textContent = v;
          valueCell.appendChild(span);
        }

        left.appendChild(label);
        left.appendChild(valueCell);

        const editBtn = document.createElement("button");
        editBtn.className = "lang-btn";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => openModal("contactItem", "edit", item));

        row.appendChild(left);
        row.appendChild(editBtn);
        contactItemsDiv.appendChild(row);
      });
    }

    async function loadContactItems() {
      if (!cMsg || !contactItemsDiv) return;
      cMsg.textContent = "Loading...";
      try {
        const res = await fetch(`${API_BASE}/contact/items`);
        contactItems = await res.json();
        if (!contactItems.length) {
          const res2 = await fetch(`${API_BASE}/contact`);
          const base = await res2.json();
          const seedPairs = [
            ["Location", base.location],
            ["Email", base.email],
            ["GitHub", base.github],
            ["LinkedIn", base.linkedin],
          ];
          for (const [title, value] of seedPairs) {
            if (value) {
              await adminFetch(`${API_BASE}/contact/items`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title, value }),
              });
            }
          }
          const res3 = await fetch(`${API_BASE}/contact/items`);
          contactItems = await res3.json();
        }
        renderContactItems();
        cMsg.textContent = "";
      } catch (e) {
        console.error(e);
        cMsg.textContent = "Failed to load contact items.";
      }
    }

    async function getAdminAuthHeaders() {
      const token = await window.__auth?.getAccessToken?.();
      if (!token) return null;
      return { Authorization: `Bearer ${token}` };
    }

    async function adminFetch(url, init = {}) {
      const authHeaders = await getAdminAuthHeaders();
      if (!authHeaders) {
        throw new Error(t("admin.guard.relogin", "Please log in again as admin."));
      }
      return fetch(url, {
        ...init,
        headers: {
          ...(init.headers || {}),
          ...authHeaders,
        },
      });
    }

    async function loadContactMessages() {
      if (!contactMessagesList) return;
      contactMessagesList.innerHTML = t("admin.common.loading", "Loading...");
      contactMessagesMsg.textContent = "";
      try {
        const authHeaders = await getAdminAuthHeaders();
        if (!authHeaders) {
          contactMessagesList.innerHTML = `<p class="muted">${t("admin.guard.relogin", "Please log in again as admin.")}</p>`;
          return;
        }
        const res = await fetch(`${API_BASE}/contact/messages`, { headers: authHeaders });
        const items = await res.json().catch(() => []);
        if (!res.ok) {
          contactMessagesList.innerHTML = `<p class="muted">${t("admin.contact.failedLoad", "Failed to load messages.")}</p>`;
          contactMessagesMsg.textContent = items?.error || `Request failed (${res.status})`;
          return;
        }

        contactMessagesList.innerHTML = "";
        if (!items.length) {
          contactMessagesList.innerHTML = `<p class="muted">${t("admin.contact.empty", "No messages yet.")}</p>`;
          return;
        }

        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "card";
          card.style.marginBottom = "0.75rem";
          const sentAt = item.createdAt ? new Date(item.createdAt).toLocaleString() : "";
          card.innerHTML = `
            <p style="margin:0"><strong>${item.name || "Unknown"}</strong> <span class="muted">(${item.email || "no email"})</span></p>
            <p style="margin:.35rem 0">${item.message || ""}</p>
            <p class="muted" style="margin:0">${sentAt}</p>
          `;
          contactMessagesList.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        contactMessagesList.innerHTML = `<p class="muted">${t("admin.contact.failedLoad", "Failed to load messages.")}</p>`;
        contactMessagesMsg.textContent = t("admin.common.networkError", "Network error");
      }
    }

    contactMessagesRefresh?.addEventListener("click", loadContactMessages);

    // Shared Admin Modal (used for Contact and About/Skills)
    const modal = document.getElementById("adminModal");
    const modalTitle = document.getElementById("adminModalTitle");
    const modalForm = document.getElementById("adminModalForm");
    const mTitle = document.getElementById("modal_title");
    const mValue = document.getElementById("modal_value");
    const modalCancel = document.getElementById("adminModalCancel");
    const mEnTitle = document.getElementById("modal_en_title");
    const mFrTitle = document.getElementById("modal_fr_title");
    const mEnDesc = document.getElementById("modal_en_desc");
    const mFrDesc = document.getElementById("modal_fr_desc");
    const mEnDate = document.getElementById("modal_en_date");
    const mFrDate = document.getElementById("modal_fr_date");
    const modalDelete = document.getElementById("adminModalDelete");
    const aboutEditSelect = document.getElementById("aboutEditSelect");
    const aboutWorkCard = document.getElementById("aboutWorkCard");
    const aboutSchoolCard = document.getElementById("aboutSchoolCard");
    function updateAboutEditView() {
      const v = aboutEditSelect?.value || "work";
      if (aboutWorkCard) {
        aboutWorkCard.hidden = v !== "work";
        aboutWorkCard.style.display = v === "work" ? "grid" : "none";
      }
      if (aboutSchoolCard) {
        aboutSchoolCard.hidden = v !== "school";
        aboutSchoolCard.style.display = v === "school" ? "grid" : "none";
      }
    }
    if (aboutEditSelect) {
      aboutEditSelect.addEventListener("change", updateAboutEditView);
      updateAboutEditView();
    }
    const workEditEnBtn = document.getElementById("workEditEnBtn");
    const workEditFrBtn = document.getElementById("workEditFrBtn");
    const schoolEditEnBtn = document.getElementById("schoolEditEnBtn");
    const schoolEditFrBtn = document.getElementById("schoolEditFrBtn");
    if (workEditEnBtn) workEditEnBtn.addEventListener("click", () => openModal("workExpEn", "edit"));
    if (workEditFrBtn) workEditFrBtn.addEventListener("click", () => openModal("workExpFr", "edit"));
    if (schoolEditEnBtn) schoolEditEnBtn.addEventListener("click", () => openModal("schoolExpEn", "edit"));
    if (schoolEditFrBtn) schoolEditFrBtn.addEventListener("click", () => openModal("schoolExpFr", "edit"));

    function openModal(context, mode, data) {
      modal.dataset.context = context;
      modal.dataset.mode = mode;
      modal.dataset.itemId = data?.id || "";
      modal.dataset.category = data?.category || "";
      modal.dataset.typeName = data?.name || "";
      if (context === "contactItem") {
        modalTitle.textContent = mode === "add" ? "Add Contact Item" : "Edit Contact Item";
        // Show EN/FR titles and value; move delete into modal for edit mode
        mTitle.style.display = "none";
        label_title.style.display = "none";
        mValue.style.display = "block";
        label_value.style.display = "block"; label_value.textContent = "Value";
        mEnTitle.style.display = "block"; label_en_title.style.display = "block"; label_en_title.textContent = "Title (EN)";
        mFrTitle.style.display = "block"; label_fr_title.style.display = "block"; label_fr_title.textContent = "Title (FR)";
        mEnDate.style.display = "none"; label_en_date.style.display = "none";
        mFrDate.style.display = "none"; label_fr_date.style.display = "none";
        mEnDesc.style.display = "none"; label_en_desc.style.display = "none";
        mFrDesc.style.display = "none"; label_fr_desc.style.display = "none";
        modalDelete.style.display = mode === "edit" ? "inline-block" : "none";
        mEnTitle.value = data?.titleEn || data?.title || "";
        mFrTitle.value = data?.titleFr || data?.title || "";
        mValue.value = data?.value || "";
      } else if (context === "skillType") {
        modalTitle.textContent = mode === "add" ? "Add Skill Type" : "Edit Skill Type";
        mTitle.style.display = "none";
        mValue.style.display = "none";
        mEnTitle.style.display = "block";
        mFrTitle.style.display = "block";
        modalDelete.style.display = mode === "edit" ? "inline-block" : "none";
        // Prefill titles if available (edit)
        const baseName = data?.name;
        const t = window.__skillsTitles?.[baseName] || { en: baseName || "", fr: baseName || "" };
        mEnTitle.value = t.en || "";
        mFrTitle.value = t.fr || "";
      } else if (context === "skillItem") {
        modalTitle.textContent = mode === "add" ? "Add Skill" : "Edit Skill";
        mTitle.style.display = "none";
        mValue.style.display = "block";
        mEnTitle.style.display = "none";
        mFrTitle.style.display = "none";
        mEnDesc.style.display = "none";
        mFrDesc.style.display = "none";
        modalDelete.style.display = mode === "edit" ? "inline-block" : "none";
        mTitle.value = "";
        mValue.value = data?.value || "";
      } else if (context === "homeField") {
        const field = data?.field;
        modal.dataset.homeField = field || "";
        modalTitle.textContent = `Edit Home ${field}`;
        // Reset visibility
        mTitle.style.display = "none";
        label_title.style.display = "none";
        mValue.style.display = "none";
        label_value.style.display = "none";
        modal_en_heading.style.display = "none";
        modal_fr_heading.style.display = "none";
        mEnTitle.style.display = "none";
        label_en_title.style.display = "none";
        mFrTitle.style.display = "none";
        label_fr_title.style.display = "none";
        mEnDate.style.display = "none";
        label_en_date.style.display = "none";
        mFrDate.style.display = "none";
        label_fr_date.style.display = "none";
        mEnDesc.style.display = "none";
        label_en_desc.style.display = "none";
        mFrDesc.style.display = "none";
        label_fr_desc.style.display = "none";
        modalDelete.style.display = "none";
        // Prefill based on field
        if (field === "image") {
          mValue.style.display = "block";
          label_value.style.display = "block";
          label_value.textContent = "Image URL";
          mValue.value = window.__homeData?.image || "";
        } else if (field === "title" || field === "current") {
          modal_en_heading.style.display = "block";
          modal_en_heading.textContent = "English";
          modal_fr_heading.style.display = "block";
          modal_fr_heading.textContent = "Français";

          mEnTitle.style.display = "block";
          label_en_title.style.display = "block";
          label_en_title.textContent = "English";
          mFrTitle.style.display = "block";
          label_fr_title.style.display = "block";
          label_fr_title.textContent = "French";

          mEnTitle.value = window.__homeData?.en?.[field] || "";
          mFrTitle.value = window.__homeData?.fr?.[field] || "";
        } else if (field === "subtitle") {
          modal_en_heading.style.display = "block";
          modal_en_heading.textContent = "English";
          modal_fr_heading.style.display = "block";
          modal_fr_heading.textContent = "Français";

          mEnDesc.style.display = "block";
          label_en_desc.style.display = "block";
          label_en_desc.textContent = "English";
          mFrDesc.style.display = "block";
          label_fr_desc.style.display = "block";
          label_fr_desc.textContent = "French";

          mEnDesc.value = window.__homeData?.en?.subtitle || "";
          mFrDesc.value = window.__homeData?.fr?.subtitle || "";
        }
      } else if (context === "workExpEn") {
        modalTitle.textContent = "Edit Work (English)";
        // Only EN fields
        mTitle.style.display = "none";
        label_title.style.display = "none";
        mValue.style.display = "none";
        label_value.style.display = "none";

        modal_en_heading.style.display = "block"; modal_en_heading.textContent = "English";
        mEnTitle.style.display = "block"; label_en_title.style.display = "block"; label_en_title.textContent = "Role (EN)";
        mEnDate.style.display = "block"; label_en_date.style.display = "block"; label_en_date.textContent = "Date (EN)";
        mEnDesc.style.display = "block"; label_en_desc.style.display = "block"; label_en_desc.textContent = "Bullets (one per line)";

        modal_fr_heading.style.display = "none";
        mFrTitle.style.display = "none"; label_fr_title.style.display = "none";
        mFrDate.style.display = "none"; label_fr_date.style.display = "none";
        mFrDesc.style.display = "none"; label_fr_desc.style.display = "none";
        modalDelete.style.display = "none";
        mEnTitle.value = window.__workData?.en?.role || "";
        mEnDate.value = window.__workData?.en?.date || "";
        mEnDesc.value = (window.__workData?.en?.bullets || []).join("\n");
      } else if (context === "workExpFr") {
        modalTitle.textContent = "Modifier le travail (Français)";
        // Only FR fields
        mTitle.style.display = "none";
        label_title.style.display = "none";
        mValue.style.display = "none";
        label_value.style.display = "none";

        modal_en_heading.style.display = "none";
        mEnTitle.style.display = "none"; label_en_title.style.display = "none";
        mEnDate.style.display = "none"; label_en_date.style.display = "none";
        mEnDesc.style.display = "none"; label_en_desc.style.display = "none";

        modal_fr_heading.style.display = "block"; modal_fr_heading.textContent = "Français";
        mFrTitle.style.display = "block"; label_fr_title.style.display = "block"; label_fr_title.textContent = "Rôle (FR)";
        mFrDate.style.display = "block"; label_fr_date.style.display = "block"; label_fr_date.textContent = "Période (FR)";
        mFrDesc.style.display = "block"; label_fr_desc.style.display = "block"; label_fr_desc.textContent = "Puces (une par ligne)";
        modalDelete.style.display = "none";
        mFrTitle.value = window.__workData?.fr?.role || "";
        mFrDate.value = window.__workData?.fr?.date || "";
        mFrDesc.value = (window.__workData?.fr?.bullets || []).join("\n");
      } else if (context === "schoolExpEn") {
        modalTitle.textContent = "Edit School (English)";
        mTitle.style.display = "none";
        label_title.style.display = "none";
        mValue.style.display = "none";
        label_value.style.display = "none";

        modal_en_heading.style.display = "block"; modal_en_heading.textContent = "English";
        mEnTitle.style.display = "block"; label_en_title.style.display = "block"; label_en_title.textContent = "Program (EN)";
        mEnDate.style.display = "block"; label_en_date.style.display = "block"; label_en_date.textContent = "Date (EN)";
        mEnDesc.style.display = "block"; label_en_desc.style.display = "block"; label_en_desc.textContent = "Bullets (one per line)";

        modal_fr_heading.style.display = "none";
        mFrTitle.style.display = "none"; label_fr_title.style.display = "none";
        mFrDate.style.display = "none"; label_fr_date.style.display = "none";
        mFrDesc.style.display = "none"; label_fr_desc.style.display = "none";
        modalDelete.style.display = "none";
        mEnTitle.value = window.__schoolData?.en?.program || "";
        mEnDate.value = window.__schoolData?.en?.date || "";
        mEnDesc.value = (window.__schoolData?.en?.bullets || []).join("\n");
      } else if (context === "schoolExpFr") {
        modalTitle.textContent = "Modifier l'école (Français)";
        mTitle.style.display = "none";
        label_title.style.display = "none";
        mValue.style.display = "none";
        label_value.style.display = "none";

        modal_en_heading.style.display = "none";
        mEnTitle.style.display = "none"; label_en_title.style.display = "none";
        mEnDate.style.display = "none"; label_en_date.style.display = "none";
        mEnDesc.style.display = "none"; label_en_desc.style.display = "none";

        modal_fr_heading.style.display = "block"; modal_fr_heading.textContent = "Français";
        mFrTitle.style.display = "block"; label_fr_title.style.display = "block"; label_fr_title.textContent = "Programme (FR)";
        mFrDate.style.display = "block"; label_fr_date.style.display = "block"; label_fr_date.textContent = "Période (FR)";
        mFrDesc.style.display = "block"; label_fr_desc.style.display = "block"; label_fr_desc.textContent = "Puces (une par ligne)";
        modalDelete.style.display = "none";
        mFrTitle.value = window.__schoolData?.fr?.program || "";
        mFrDate.value = window.__schoolData?.fr?.date || "";
        mFrDesc.value = (window.__schoolData?.fr?.bullets || []).join("\n");
      }
      modal.hidden = false;
    }

    function closeModal() {
      modal.hidden = true;
      modal.dataset.context = "";
      modal.dataset.mode = "";
      modal.dataset.itemId = "";
      // Clear messages
      if (cMsg) cMsg.textContent = "";
      if (typeof aboutMsg !== "undefined" && aboutMsg) aboutMsg.textContent = "";
    }

    modalCancel.addEventListener("click", closeModal);

    modalForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const context = modal.dataset.context;
      const mode = modal.dataset.mode;
      try {
        if (context === "contactItem") {
          cMsg.textContent = "Saving...";
          const payload = { titleEn: mEnTitle.value.trim(), titleFr: mFrTitle.value.trim(), value: mValue.value.trim() };
          const itemId = modal.dataset.itemId;
          const url = mode === "edit" ? `${API_BASE}/contact/items/${itemId}` : `${API_BASE}/contact/items`;
          const method = mode === "edit" ? "PUT" : "POST";
          const res = await adminFetch(url, { method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
          const data = await res.json();
          if (!res.ok) { cMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          closeModal();
          await loadContactItems();
          cMsg.textContent = "Saved.";
        } else if (context === "skillType") {
          aboutMsg.textContent = "Saving...";
          const selected = modal.dataset.typeName;
          if (mode === "add") {
            // Create type key from English title (simple slug)
            const en = mEnTitle.value.trim();
            const fr = mFrTitle.value.trim();
            const name = en.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "") || en;
            const res = await adminFetch(`${API_BASE}/skills/types`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
            const res2 = await adminFetch(`${API_BASE}/skills/types/${encodeURIComponent(name)}/titles`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ en, fr }) });
            const data2 = await res2.json();
            if (!res2.ok) { aboutMsg.textContent = (data2.errors?.[0]?.msg) || data2.error || "Save failed"; return; }
          } else {
            // Save bilingual titles for the selected type
            const res = await adminFetch(`${API_BASE}/skills/types/${encodeURIComponent(selected)}/titles`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ en: mEnTitle.value.trim(), fr: mFrTitle.value.trim() }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          }
          closeModal();
          await loadAboutSkills();
          aboutMsg.textContent = "Saved.";
        } else if (context === "skillItem") {
          aboutMsg.textContent = "Saving...";
          const category = modal.dataset.category;
          const value = mValue.value.trim();
          if (mode === "add") {
            const res = await adminFetch(`${API_BASE}/skills/items`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ category, value }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          } else {
            const oldValue = modal.dataset.itemId;
            const res = await adminFetch(`${API_BASE}/skills/items`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ category, oldValue, newValue: value }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          }
          closeModal();
          await loadAboutSkills();
          aboutMsg.textContent = "Saved.";
        } else if (context === "homeField") {
          hMsg.textContent = "Saving...";
          const field = modal.dataset.homeField;
          // Build payload from current home data to avoid resetting other fields to defaults
          const base = window.__homeData || {};
          const payload = {
            image: base.image,
            en: { ...(base.en || {}) },
            fr: { ...(base.fr || {}) },
          };
          if (field === "image") {
            payload.image = mValue.value.trim() || base.image || "";
          } else if (field === "title") {
            payload.en.title = mEnTitle.value.trim();
            payload.fr.title = mFrTitle.value.trim();
          } else if (field === "subtitle") {
            payload.en.subtitle = mEnDesc.value.trim();
            payload.fr.subtitle = mFrDesc.value.trim();
          } else if (field === "current") {
            payload.en.current = mEnTitle.value.trim();
            payload.fr.current = mFrTitle.value.trim();
          }
          const res = await adminFetch(`${API_BASE}/home`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) { hMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          closeModal();
          await loadHome();
          hMsg.textContent = "Saved.";
        } else if (context === "workExpEn") {
          workMsg.textContent = "Saving...";
          const base = window.__workData || {};
          const payload = {
            company: base.company,
            en: {
              role: mEnTitle.value.trim(),
              date: mEnDate.value.trim(),
              bullets: mEnDesc.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean),
            },
            fr: base.fr || {},
          };
          const res = await adminFetch(`${API_BASE}/about/work`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) { workMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          closeModal();
          await loadWork();
          workMsg.textContent = "Saved.";
        } else if (context === "workExpFr") {
          workMsg.textContent = "Saving...";
          const base = window.__workData || {};
          const payload = {
            company: base.company,
            en: base.en || {},
            fr: {
              role: mFrTitle.value.trim(),
              date: mFrDate.value.trim(),
              bullets: mFrDesc.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean),
            },
          };
          const res = await adminFetch(`${API_BASE}/about/work`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) { workMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          closeModal();
          await loadWork();
          workMsg.textContent = "Saved.";
        } else if (context === "schoolExpEn") {
          schoolMsg.textContent = "Saving...";
          const base = window.__schoolData || {};
          const payload = {
            en: {
              program: mEnTitle.value.trim(),
              date: mEnDate.value.trim(),
              bullets: mEnDesc.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean),
            },
            fr: base.fr || {},
          };
          const res = await adminFetch(`${API_BASE}/about/school`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) { schoolMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          closeModal();
          await loadSchool();
          schoolMsg.textContent = "Saved.";
        } else if (context === "schoolExpFr") {
          schoolMsg.textContent = "Saving...";
          const base = window.__schoolData || {};
          const payload = {
            en: base.en || {},
            fr: {
              program: mFrTitle.value.trim(),
              date: mFrDate.value.trim(),
              bullets: mFrDesc.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean),
            },
          };
          const res = await adminFetch(`${API_BASE}/about/school`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) { schoolMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          closeModal();
          await loadSchool();
          schoolMsg.textContent = "Saved.";
        }
      } catch (err) {
        console.error(err);
        if (context === "contactItem") cMsg.textContent = "Network error";
        else if (context === "skillType" || context === "skillItem") aboutMsg.textContent = "Network error";
        else if (context === "schoolExpEn" || context === "schoolExpFr") schoolMsg.textContent = "Network error";
        else hMsg.textContent = "Network error";
      }
    });

    // Modal delete actions (skillType edit, skillItem edit, contactItem edit)
    modalDelete.addEventListener("click", async () => {
      const context = modal.dataset.context;
      try {
        if (context === "skillType") {
          const name = modal.dataset.typeName || (mEnTitle.value.trim().toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "") || mEnTitle.value.trim());
          if (!confirm("Delete this type and all its skills?")) return;
          const res = await adminFetch(`${API_BASE}/skills/types/${encodeURIComponent(name)}`, { method: "DELETE" });
          if (res.ok) { closeModal(); loadAboutSkills(); }
        } else if (context === "skillItem") {
          const category = modal.dataset.category;
          const oldValue = modal.dataset.itemId;
          if (!confirm("Delete this skill?")) return;
          const res = await adminFetch(`${API_BASE}/skills/items`, { method: "DELETE", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ category, value: oldValue }) });
          if (res.ok) { closeModal(); loadAboutSkills(); }
        } else if (context === "contactItem") {
          const itemId = modal.dataset.itemId;
          if (!confirm("Delete this contact item?")) return;
          const res = await adminFetch(`${API_BASE}/contact/items/${itemId}`, { method: "DELETE" });
          if (res.ok) { closeModal(); loadContactItems(); }
        }
      } catch (e) { console.error(e); }
    });

    async function deleteContactItem(id) {
      if (!confirm("Delete this contact item?")) return;
      try {
        const res = await adminFetch(`${API_BASE}/contact/items/${id}`, { method: "DELETE" });
        if (res.ok) {
          await loadContactItems();
        }
      } catch (e) {
        console.error(e);
      }
    }

    // Testimonials API
    const tList = document.getElementById("testimonialsList");

    async function renderTestimonials() {
      tList.innerHTML = t("admin.common.loading", "Loading...");
      try {
        const authHeaders = await getAdminAuthHeaders();
        if (!authHeaders) {
          tList.innerHTML = `<p class="muted">${t("admin.guard.relogin", "Please log in again as admin.")}</p>`;
          return;
        }

        const res = await fetch(`${API_BASE}/testimonials/admin`, { headers: authHeaders });
        const data = await res.json().catch(() => null);
        if (!res.ok) {
          const msg = data?.error || data?.message || `Request failed (${res.status})`;
          tList.innerHTML = `<p class="muted">${msg}</p>`;
          return;
        }

        const items = Array.isArray(data) ? data : [];
        tList.innerHTML = "";
        if (!items.length) {
          tList.innerHTML = `<p class="muted">${t("testimonials.empty", "No testimonials yet.")}</p>`;
          return;
        }
        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "card";
          card.style.padding = "0.75rem";
          const status = item.approved ? t("admin.testimonials.approved", "Approved") : t("admin.testimonials.pending", "Pending");
          const approveBtnHtml = item.approved ? "" : `<button class=\"lang-btn\" data-approve=\"${item.id}\">${t("admin.testimonials.approve", "Approve")}</button>`;
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;">
              <div>
                <strong>${item.author}</strong>
                <p class="muted" style="margin:.15rem 0 0;">${status}</p>
              </div>
              <div style="display:flex;gap:.5rem;">
                ${approveBtnHtml}
                <button class="lang-btn" data-del="${item.id}">${t("admin.common.delete", "Delete")}</button>
              </div>
            </div>
            <p style="margin:.5rem 0 0">${item.quote || ""}</p>
          `;
          const approveBtn = card.querySelector(`[data-approve="${item.id}"]`);
          const delBtn = card.querySelector(`[data-del="${item.id}"]`);
          approveBtn?.addEventListener("click", () => approveTestimonial(item.id));
          delBtn.addEventListener("click", () => deleteTestimonial(item.id));
          tList.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        tList.textContent = t("admin.testimonials.failedLoad", "Failed to load testimonials.");
      }
    }

    async function approveTestimonial(id) {
      try {
        const res = await adminFetch(`${API_BASE}/testimonials/${id}/approve`, {
          method: "PUT",
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || err.message || `Approve failed (${res.status})`);
        }
        renderTestimonials();
      } catch (e) {
        console.error(e);
        tList.innerHTML = `<p class="muted">${e.message || "Failed to approve testimonial."}</p>`;
      }
    }

    async function deleteTestimonial(id) {
      if (!confirm("Delete this testimonial?")) return;
      try {
        const res = await adminFetch(`${API_BASE}/testimonials/${id}`, { method: "DELETE" });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || err.message || `Delete failed (${res.status})`);
        }
        renderTestimonials();
      } catch (e) {
        console.error(e);
        tList.innerHTML = `<p class="muted">${e.message || "Failed to delete testimonial."}</p>`;
      }
    }

    // Skills management (flat list + edit modal)
    const aboutSkillsList = document.getElementById("about_skills_list");
    const aboutMsg = document.getElementById("aboutMsg");
    const skillAddBtn = document.getElementById("skillAddBtn");
    const skillEditModal = document.getElementById("skillEditModal");
    const skillEditForm = document.getElementById("skillEditForm");
    const skillEditCancel = document.getElementById("skillEditCancel");
    const skillEditDelete = document.getElementById("skillEditDelete");
    const skillEditTitle = document.getElementById("skillEditTitle");
    const skillNameEnInput = document.getElementById("skillNameEnInput");
    const skillNameFrInput = document.getElementById("skillNameFrInput");
    const skillTypeEnInput = document.getElementById("skillTypeEnInput");
    const skillTypeFrInput = document.getElementById("skillTypeFrInput");
    const skillRatingInput = document.getElementById("skillRatingInput");
    const skillImageInput = document.getElementById("skillImageInput");
    const skillImageBrowseBtn = document.getElementById("skillImageBrowseBtn");
    const skillImageFileInput = document.getElementById("skillImageFile");
    const skillImageStatus = document.getElementById("skillImageStatus");

    let skillsData = {};
    let skillsTitles = {};
    let skillsMeta = {};
    let editingSkill = null;
    const MAX_SKILL_IMAGE_BYTES = 300 * 1024;

    function flattenSkills(skills) {
      const rows = [];
      Object.entries(skills || {}).forEach(([type, values]) => {
        (values || []).forEach((name) => {
          const titleEn = skillsMeta?.[name]?.titleEn || name;
          const titleFr = skillsMeta?.[name]?.titleFr || titleEn;
          rows.push({
            name,
            type,
            titleEn,
            titleFr,
            rating: Math.max(1, Math.min(5, Number(skillsMeta?.[name]?.rating ?? 3))),
            image: skillsMeta?.[name]?.image || "/assets/placeholder-skill.svg",
          });
        });
      });
      return rows.sort((a, b) => a.name.localeCompare(b.name) || a.type.localeCompare(b.type));
    }

    function renderSkillsList() {
      aboutSkillsList.innerHTML = "";
      const rows = flattenSkills(skillsData);
      if (!rows.length) {
        aboutSkillsList.innerHTML = `<p class="muted">${t("skills.empty", "No skills yet.")}</p>`;
        return;
      }

      rows.forEach((row) => {
        const item = document.createElement("div");
        item.className = "card";
        item.style.display = "grid";
        item.style.gridTemplateColumns = "2fr 1.5fr .8fr auto";
        item.style.alignItems = "center";
        item.style.gap = ".5rem";
        const typeLabel = skillsTitles?.[row.type]?.en || row.type;
        item.innerHTML = `
          <span><strong>${row.titleEn || row.name}</strong></span>
          <span class="muted">${typeLabel}</span>
          <span>${row.rating}/5</span>
          <button class="lang-btn" data-edit-skill="${encodeURIComponent(row.name)}|${encodeURIComponent(row.type)}">Edit</button>
        `;
        item.querySelector("[data-edit-skill]")?.addEventListener("click", () => openSkillEditModal(row));
        aboutSkillsList.appendChild(item);
      });
    }

    function openSkillEditModal(skill) {
      editingSkill = skill ? { ...skill, originalName: skill.name, originalType: skill.type } : null;
      skillEditTitle.textContent = editingSkill ? "Edit Skill" : "Add Skill";
      skillEditDelete.style.display = editingSkill ? "inline-block" : "none";
      skillNameEnInput.value = skill?.titleEn || skill?.name || "";
      skillNameFrInput.value = skill?.titleFr || skill?.titleEn || skill?.name || "";
      const typeTitles = skillsTitles?.[skill?.type] || {};
      skillTypeEnInput.value = typeTitles.en || skill?.type || "";
      skillTypeFrInput.value = typeTitles.fr || typeTitles.en || skill?.type || "";
      skillRatingInput.value = String(skill?.rating || 3);
      skillImageInput.value = skill?.image || "";
      if (skillImageStatus) {
        skillImageStatus.textContent = (skill?.image || "").startsWith("data:image/")
          ? "Uploaded image selected"
          : "";
      }

      skillEditModal.hidden = false;
    }

    function closeSkillEditModal() {
      skillEditModal.hidden = true;
      editingSkill = null;
    }

    async function loadAboutSkills() {
      aboutSkillsList.innerHTML = t("admin.common.loading", "Loading...");
      try {
        const [skillsRes, titlesRes, metaRes] = await Promise.all([
          fetch(`${API_BASE}/skills`),
          fetch(`${API_BASE}/skills/titles`),
          fetch(`${API_BASE}/skills/meta`),
        ]);
        skillsData = await skillsRes.json();
        skillsTitles = await titlesRes.json();
        skillsMeta = await metaRes.json();
        renderSkillsList();
        aboutMsg.textContent = "";
      } catch (e) {
        console.error(e);
        aboutSkillsList.textContent = t("skills.failed", "Failed to load skills.");
      }
    }

    skillAddBtn?.addEventListener("click", () => openSkillEditModal(null));
    skillImageBrowseBtn?.addEventListener("click", () => {
      skillImageFileInput?.click();
    });
    skillImageFileInput?.addEventListener("change", async () => {
      const file = skillImageFileInput.files?.[0];
      if (!file) return;
      if (file.size > MAX_SKILL_IMAGE_BYTES) {
        const maxKb = Math.round(MAX_SKILL_IMAGE_BYTES / 1024);
        const actualKb = Math.round(file.size / 1024);
        if (skillImageStatus) skillImageStatus.textContent = `Image too large (${actualKb} KB). Max allowed is ${maxKb} KB.`;
        aboutMsg.textContent = `Image too large. Please choose an image up to ${maxKb} KB.`;
        skillImageFileInput.value = "";
        return;
      }
      try {
        const imageData = await fileToDataUrl(file);
        skillImageInput.value = imageData;
        if (skillImageStatus) skillImageStatus.textContent = file.name;
        aboutMsg.textContent = "";
      } catch (err) {
        console.error(err);
        if (skillImageStatus) skillImageStatus.textContent = "Failed to load image file";
      }
      skillImageFileInput.value = "";
    });
    skillEditCancel?.addEventListener("click", closeSkillEditModal);
    skillEditModal?.addEventListener("click", (e) => {
      if (e.target === skillEditModal) closeSkillEditModal();
    });

    skillEditForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      aboutMsg.textContent = "Saving...";
      try {
        const newTitleEn = skillNameEnInput.value.trim();
        const newTitleFr = skillNameFrInput.value.trim();
        const newName = newTitleEn;
        const newTypeEn = skillTypeEnInput.value.trim();
        const newTypeFr = skillTypeFrInput.value.trim();
        const newType = newTypeEn;
        const newRating = Number(skillRatingInput.value || 3);
        const newImage = skillImageInput.value.trim();

        if (!newTitleEn || !newTypeEn || !newTypeFr) {
          aboutMsg.textContent = "English/French title and type are required.";
          return;
        }

        if (!editingSkill) {
          const addRes = await adminFetch(`${API_BASE}/skills/items`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ category: newType, value: newName }),
          });
          if (!addRes.ok) {
            const err = await addRes.json().catch(() => ({}));
            throw new Error(err.error || err.errors?.[0]?.msg || `Add failed (${addRes.status})`);
          }
        } else {
          if (editingSkill.originalType === newType) {
            if (editingSkill.originalName !== newName) {
              const renameRes = await adminFetch(`${API_BASE}/skills/items`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ category: newType, oldValue: editingSkill.originalName, newValue: newName }),
              });
              if (!renameRes.ok) {
                const err = await renameRes.json().catch(() => ({}));
                throw new Error(err.error || err.errors?.[0]?.msg || `Rename failed (${renameRes.status})`);
              }
            }
          } else {
            const delRes = await adminFetch(`${API_BASE}/skills/items`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ category: editingSkill.originalType, value: editingSkill.originalName }),
            });
            if (!delRes.ok) {
              const err = await delRes.json().catch(() => ({}));
              throw new Error(err.error || err.errors?.[0]?.msg || `Move failed (${delRes.status})`);
            }

            const addRes = await adminFetch(`${API_BASE}/skills/items`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ category: newType, value: newName }),
            });
            if (!addRes.ok) {
              const err = await addRes.json().catch(() => ({}));
              throw new Error(err.error || err.errors?.[0]?.msg || `Move failed (${addRes.status})`);
            }
          }
        }

        const typeTitleRes = await adminFetch(`${API_BASE}/skills/types/${encodeURIComponent(newType)}/titles`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ en: newTypeEn, fr: newTypeFr }),
        });
        if (!typeTitleRes.ok) {
          const err = await typeTitleRes.json().catch(() => ({}));
          throw new Error(err.error || err.errors?.[0]?.msg || `Type title save failed (${typeTitleRes.status})`);
        }

        const metaRes = await adminFetch(`${API_BASE}/skills/meta/${encodeURIComponent(newName)}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: newImage, rating: newRating, titleEn: newTitleEn || newName, titleFr: newTitleFr || newTitleEn || newName }),
        });
        if (!metaRes.ok) {
          if (metaRes.status === 413) {
            const maxKb = Math.round(MAX_SKILL_IMAGE_BYTES / 1024);
            throw new Error(`Image payload is too large. Please keep skill images under ${maxKb} KB.`);
          }
          const err = await metaRes.json().catch(() => ({}));
          throw new Error(err.error || err.errors?.[0]?.msg || `Meta save failed (${metaRes.status})`);
        }

        if (editingSkill && editingSkill.originalName !== newName) {
          await adminFetch(`${API_BASE}/skills/meta/${encodeURIComponent(editingSkill.originalName)}`, { method: "DELETE" }).catch(() => null);
        }

        closeSkillEditModal();
        await loadAboutSkills();
        aboutMsg.textContent = "Saved.";
      } catch (err) {
        console.error(err);
        aboutMsg.textContent = err.message || "Save failed";
      }
    });

    skillEditDelete?.addEventListener("click", async () => {
      if (!editingSkill) return;
      if (!confirm("Delete this skill?")) return;
      aboutMsg.textContent = "Deleting...";
      try {
        const delRes = await adminFetch(`${API_BASE}/skills/items`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ category: editingSkill.originalType, value: editingSkill.originalName }),
        });
        if (!delRes.ok) {
          const err = await delRes.json().catch(() => ({}));
          throw new Error(err.error || err.errors?.[0]?.msg || `Delete failed (${delRes.status})`);
        }

        await adminFetch(`${API_BASE}/skills/meta/${encodeURIComponent(editingSkill.originalName)}`, { method: "DELETE" }).catch(() => null);
        closeSkillEditModal();
        await loadAboutSkills();
        aboutMsg.textContent = "Deleted.";
      } catch (err) {
        console.error(err);
        aboutMsg.textContent = err.message || "Delete failed";
      }
    });

    // Initial loads
    // Home
    // Removed form inputs; using modal-based editing
    const hMsg = document.getElementById("homeMsg");

    async function loadHome() {
      try {
        const res = await fetch(`${API_BASE}/home`);
        window.__homeData = await res.json();
        // Populate display elements if present
        if (homePreview) homePreview.src = window.__homeData.image || "";
        if (homeImageUrl) {
          const img = window.__homeData.image || "";
          homeImageUrl.textContent = img.startsWith("data:image/") ? "Uploaded image" : img;
        }
        if (homeTitleEnEl) homeTitleEnEl.textContent = window.__homeData.en?.title || "";
        if (homeTitleFrEl) homeTitleFrEl.textContent = window.__homeData.fr?.title || "";
        if (homeSubtitleEnEl) homeSubtitleEnEl.textContent = window.__homeData.en?.subtitle || "";
        if (homeSubtitleFrEl) homeSubtitleFrEl.textContent = window.__homeData.fr?.subtitle || "";
        if (homeCurrentEnEl) homeCurrentEnEl.textContent = window.__homeData.en?.current || "";
        if (homeCurrentFrEl) homeCurrentFrEl.textContent = window.__homeData.fr?.current || "";
      } catch (e) {
        console.error(e);
        hMsg.textContent = "Failed to load home content.";
      }
    }

    // Home field edit handlers using modal
    const homePreview = document.getElementById("homePreview");
    const homeImageUrl = document.getElementById("homeImageUrl");
    const homeEditImageBtn = document.getElementById("homeEditImage");
    const homeImageFileInput = document.getElementById("homeImageFile");
    const homeTitleEnEl = document.getElementById("homeTitleEn");
    const homeTitleFrEl = document.getElementById("homeTitleFr");
    const homeSubtitleEnEl = document.getElementById("homeSubtitleEn");
    const homeSubtitleFrEl = document.getElementById("homeSubtitleFr");
    const homeCurrentEnEl = document.getElementById("homeCurrentEn");
    const homeCurrentFrEl = document.getElementById("homeCurrentFr");
    const homeEditTitleBtn = document.getElementById("homeEditTitle");
    const homeEditSubtitleBtn = document.getElementById("homeEditSubtitle");
    const homeEditCurrentBtn = document.getElementById("homeEditCurrent");

    async function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ""));
        reader.onerror = () => reject(new Error("Failed to read image file."));
        reader.readAsDataURL(file);
      });
    }

    async function saveHomeImageFromFile(file) {
      if (!file) return;
      hMsg.textContent = "Saving...";
      try {
        const imageData = await fileToDataUrl(file);
        const base = window.__homeData || {};
        const payload = {
          image: imageData,
          en: { ...(base.en || {}) },
          fr: { ...(base.fr || {}) },
        };
        const res = await adminFetch(`${API_BASE}/home`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          hMsg.textContent = data.errors?.[0]?.msg || data.error || "Save failed";
          return;
        }
        await loadHome();
        hMsg.textContent = "Saved.";
      } catch (err) {
        console.error(err);
        hMsg.textContent = err.message || "Network error";
      }
    }

    homeEditImageBtn?.addEventListener("click", () => {
      homeImageFileInput?.click();
    });

    homeImageFileInput?.addEventListener("change", async () => {
      const file = homeImageFileInput.files?.[0];
      await saveHomeImageFromFile(file);
      homeImageFileInput.value = "";
    });

    if (homeEditTitleBtn) homeEditTitleBtn.addEventListener("click", () => openModal("homeField", "edit", { field: "title" }));
    if (homeEditSubtitleBtn) homeEditSubtitleBtn.addEventListener("click", () => openModal("homeField", "edit", { field: "subtitle" }));
    if (homeEditCurrentBtn) homeEditCurrentBtn.addEventListener("click", () => openModal("homeField", "edit", { field: "current" }));

    // Removed old form submit; edits are handled via modal submit

    // Projects management (flat list + edit modal)
    const projectsList = document.getElementById("projectsList");
    const pMsg = document.getElementById("projectsMsg");
    const projectAddBtn = document.getElementById("projectAddBtn");
    const projectEditModal = document.getElementById("projectEditModal");
    const projectEditForm = document.getElementById("projectEditForm");
    const projectEditTitle = document.getElementById("projectEditTitle");
    const projectEditDelete = document.getElementById("projectEditDelete");
    const projectEditCancel = document.getElementById("projectEditCancel");
    const projectIdInput = document.getElementById("projectIdInput");
    const projectImageInput = document.getElementById("projectImageInput");
    const projectImageBrowseBtn = document.getElementById("projectImageBrowseBtn");
    const projectImageFileInput = document.getElementById("projectImageFile");
    const projectImageStatus = document.getElementById("projectImageStatus");
    const projectEnTitleInput = document.getElementById("projectEnTitleInput");
    const projectEnDateInput = document.getElementById("projectEnDateInput");
    const projectEnDescInput = document.getElementById("projectEnDescInput");
    const projectFrTitleInput = document.getElementById("projectFrTitleInput");
    const projectFrDateInput = document.getElementById("projectFrDateInput");
    const projectFrDescInput = document.getElementById("projectFrDescInput");
    const projectTabEn = document.getElementById("projectTabEn");
    const projectTabFr = document.getElementById("projectTabFr");
    const projectEnPanel = document.getElementById("projectEnPanel");
    const projectFrPanel = document.getElementById("projectFrPanel");

    let projectsData = {};
    let editingProjectId = null;
    const MAX_PROJECT_IMAGE_BYTES = 300 * 1024;

    function setProjectLangTab(lang) {
      const isEn = lang === "en";
      projectEnPanel.hidden = !isEn;
      projectFrPanel.hidden = isEn;
      projectTabEn?.classList.toggle("active", isEn);
      projectTabFr?.classList.toggle("active", !isEn);
      projectTabEn?.setAttribute("aria-selected", isEn ? "true" : "false");
      projectTabFr?.setAttribute("aria-selected", !isEn ? "true" : "false");
    }

    function renderProjectsList() {
      projectsList.innerHTML = "";
      const rows = Object.entries(projectsData || {}).sort(([a], [b]) => a.localeCompare(b));
      if (!rows.length) {
        projectsList.innerHTML = `<p class="muted">${t("projects.empty", "No projects yet.")}</p>`;
        return;
      }

      rows.forEach(([id, entry]) => {
        const item = document.createElement("div");
        item.className = "card";
        item.style.display = "grid";
        item.style.gridTemplateColumns = "1fr 2fr 1.2fr auto";
        item.style.alignItems = "center";
        item.style.gap = ".5rem";
        item.innerHTML = `
          <span><strong>${id}</strong></span>
          <span class="muted">${entry.en?.title || id}</span>
          <span>${entry.en?.date || "-"}</span>
          <button class="lang-btn" data-edit-project="${id}">Edit</button>
        `;
        item.querySelector("[data-edit-project]")?.addEventListener("click", () => openProjectEditModal(id, entry));
        projectsList.appendChild(item);
      });
    }

    function openProjectEditModal(id, entry) {
      editingProjectId = id || null;
      const data = entry || {
        image: "/assets/image1.png",
        en: { title: "", date: "", desc: "" },
        fr: { title: "", date: "", desc: "" },
      };

      projectEditTitle.textContent = editingProjectId ? "Edit Project" : "Add Project";
      projectEditDelete.style.display = editingProjectId ? "inline-block" : "none";
      projectIdInput.disabled = !!editingProjectId;
      projectIdInput.value = editingProjectId || "";
      projectImageInput.value = data.image || "";
      if (projectImageStatus) {
        projectImageStatus.textContent = (data.image || "").startsWith("data:image/")
          ? "Uploaded image selected"
          : "";
      }
      projectEnTitleInput.value = data.en?.title || "";
      projectEnDateInput.value = data.en?.date || "";
      projectEnDescInput.value = data.en?.desc || "";
      projectFrTitleInput.value = data.fr?.title || "";
      projectFrDateInput.value = data.fr?.date || "";
      projectFrDescInput.value = data.fr?.desc || "";
      setProjectLangTab("en");

      projectEditModal.hidden = false;
    }

    function closeProjectEditModal() {
      projectEditModal.hidden = true;
      editingProjectId = null;
    }

    async function loadProjectsList() {
      projectsList.innerHTML = t("admin.common.loading", "Loading...");
      try {
        const res = await fetch(`${API_BASE}/projects`);
        projectsData = await res.json();
        renderProjectsList();
        pMsg.textContent = "";
      } catch (e) {
        console.error(e);
        projectsList.innerHTML = `<p class="muted">${t("projects.failed", "Failed to load projects.")}</p>`;
      }
    }

    projectAddBtn?.addEventListener("click", () => openProjectEditModal());
    projectImageBrowseBtn?.addEventListener("click", () => {
      projectImageFileInput?.click();
    });
    projectImageFileInput?.addEventListener("change", async () => {
      const file = projectImageFileInput.files?.[0];
      if (!file) return;
      if (file.size > MAX_PROJECT_IMAGE_BYTES) {
        const maxKb = Math.round(MAX_PROJECT_IMAGE_BYTES / 1024);
        const actualKb = Math.round(file.size / 1024);
        if (projectImageStatus) projectImageStatus.textContent = `Image too large (${actualKb} KB). Max allowed is ${maxKb} KB.`;
        pMsg.textContent = `Image too large. Please choose an image up to ${maxKb} KB.`;
        projectImageFileInput.value = "";
        return;
      }

      try {
        const imageData = await fileToDataUrl(file);
        projectImageInput.value = imageData;
        if (projectImageStatus) projectImageStatus.textContent = file.name;
        pMsg.textContent = "";
      } catch (err) {
        console.error(err);
        if (projectImageStatus) projectImageStatus.textContent = "Failed to load image file";
      }
      projectImageFileInput.value = "";
    });
    projectTabEn?.addEventListener("click", () => setProjectLangTab("en"));
    projectTabFr?.addEventListener("click", () => setProjectLangTab("fr"));
    projectEditCancel?.addEventListener("click", closeProjectEditModal);
    projectEditModal?.addEventListener("click", (e) => {
      if (e.target === projectEditModal) closeProjectEditModal();
    });

    projectEditForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      pMsg.textContent = "Saving...";

      const id = (editingProjectId || projectIdInput.value || "").trim();
      if (!/^[a-z0-9-]{2,}$/i.test(id)) {
        pMsg.textContent = "Project ID must use letters, numbers, and dashes.";
        return;
      }

      const payload = {
        image: projectImageInput.value.trim(),
        en: {
          title: projectEnTitleInput.value.trim(),
          date: projectEnDateInput.value.trim(),
          desc: projectEnDescInput.value.trim(),
        },
        fr: {
          title: projectFrTitleInput.value.trim(),
          date: projectFrDateInput.value.trim(),
          desc: projectFrDescInput.value.trim(),
        },
      };

      try {
        const res = await adminFetch(editingProjectId ? `${API_BASE}/projects/${editingProjectId}` : `${API_BASE}/projects`, {
          method: editingProjectId ? "PUT" : "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(editingProjectId ? payload : { id, ...payload }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          pMsg.textContent = data.errors?.[0]?.msg || data.error || "Save failed";
          return;
        }

        closeProjectEditModal();
        await loadProjectsList();
        pMsg.textContent = "Saved.";
      } catch (err) {
        console.error(err);
        pMsg.textContent = "Network error";
      }
    });

    projectEditDelete?.addEventListener("click", async () => {
      if (!editingProjectId) return;
      if (!confirm("Delete this project?")) return;

      pMsg.textContent = "Deleting...";
      try {
        const res = await adminFetch(`${API_BASE}/projects/${editingProjectId}`, { method: "DELETE" });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          pMsg.textContent = data.errors?.[0]?.msg || data.error || "Delete failed";
          return;
        }

        closeProjectEditModal();
        await loadProjectsList();
        pMsg.textContent = "Deleted.";
      } catch (err) {
        console.error(err);
        pMsg.textContent = "Network error";
      }
    });

    loadHome();
    loadWork();
    loadSchool();
    await loadProjectsList();
    renderTestimonials();
    loadAboutSkills();
  </script>

  <!-- Admin Modal (shared; currently used for Contact Items) -->
  <div id="adminModal" class="modal-overlay" hidden>
    <div class="modal">
      <h3 id="adminModalTitle" style="margin-top:0;">Edit</h3>
      <form id="adminModalForm" style="display:grid;gap:.5rem;">
        <label id="label_title" for="modal_title" style="display:none;">Title</label>
        <input id="modal_title" placeholder="Title" />
        <label id="label_value" for="modal_value" style="display:none;">Value</label>
        <input id="modal_value" placeholder="Value" />

        <h4 id="modal_en_heading" style="margin:.25rem 0; display:none;">English</h4>
        <label id="label_en_title" for="modal_en_title" style="display:none;">English title</label>
        <input id="modal_en_title" placeholder="English title" style="display:none;" />
        <label id="label_en_date" for="modal_en_date" style="display:none;">English date range</label>
        <input id="modal_en_date" placeholder="English date range" style="display:none;" />
        <label id="label_en_desc" for="modal_en_desc" style="display:none;">English description</label>
        <textarea id="modal_en_desc" placeholder="English description" rows="4" style="display:none;"></textarea>

        <h4 id="modal_fr_heading" style="margin:.25rem 0; display:none;">Français</h4>
        <label id="label_fr_title" for="modal_fr_title" style="display:none;">French title</label>
        <input id="modal_fr_title" placeholder="French title" style="display:none;" />
        <label id="label_fr_date" for="modal_fr_date" style="display:none;">French date range</label>
        <input id="modal_fr_date" placeholder="French date range" style="display:none;" />
        <label id="label_fr_desc" for="modal_fr_desc" style="display:none;">French description</label>
        <textarea id="modal_fr_desc" placeholder="French description" rows="4" style="display:none;"></textarea>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem;">
          <button type="button" id="adminModalDelete" class="lang-btn" style="margin-right:auto;display:none;" data-i18n="admin.common.delete">Delete</button>
          <button type="button" id="adminModalCancel" class="lang-btn" data-i18n="testimonials.cancel">Cancel</button>
          <button type="submit" class="lang-btn" data-i18n="admin.common.save">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="skillEditModal" class="modal-overlay" hidden>
    <div class="modal">
      <h3 id="skillEditTitle" style="margin-top:0;">Edit Skill</h3>
      <form id="skillEditForm" style="display:grid;gap:.5rem;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;">
          <div>
            <label for="skillNameEnInput">English Title</label>
            <input id="skillNameEnInput" required />
          </div>
          <div>
            <label for="skillTypeEnInput">English Type</label>
            <input id="skillTypeEnInput" required />
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;">
          <div>
            <label for="skillNameFrInput">French Title</label>
            <input id="skillNameFrInput" required />
          </div>
          <div>
            <label for="skillTypeFrInput">French Type</label>
            <input id="skillTypeFrInput" required />
          </div>
        </div>

        <label for="skillRatingInput">Rating (1-5)</label>
        <input id="skillRatingInput" type="number" min="1" max="5" step="1" required />

        <label for="skillImageInput">Image URL</label>
        <input id="skillImageInput" placeholder="/assets/placeholder-skill.svg" />
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
          <button type="button" id="skillImageBrowseBtn" class="lang-btn">Choose from explorer</button>
          <span id="skillImageStatus" class="muted"></span>
        </div>
        <input id="skillImageFile" type="file" accept="image/*" style="display:none;" />

        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem;">
          <button type="button" id="skillEditDelete" class="lang-btn" style="margin-right:auto;">Delete</button>
          <button type="button" id="skillEditCancel" class="lang-btn">Cancel</button>
          <button type="submit" class="lang-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="projectEditModal" class="modal-overlay" hidden>
    <div class="modal project-modal">
      <h3 id="projectEditTitle" style="margin-top:0;">Edit Project</h3>
      <form id="projectEditForm" style="display:grid;gap:.5rem;">
        <label for="projectIdInput">Project ID</label>
        <input id="projectIdInput" placeholder="my-project-id" required />

        <label for="projectImageInput">Image URL</label>
        <input id="projectImageInput" placeholder="/assets/image1.png" />
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
          <button type="button" id="projectImageBrowseBtn" class="lang-btn">Choose from explorer</button>
          <span id="projectImageStatus" class="muted"></span>
        </div>
        <input id="projectImageFile" type="file" accept="image/*" style="display:none;" />

        <div class="project-lang-tabs" role="tablist" aria-label="Project language tabs">
          <button type="button" id="projectTabEn" class="project-lang-tab active" role="tab" aria-selected="true">English</button>
          <button type="button" id="projectTabFr" class="project-lang-tab" role="tab" aria-selected="false">Français</button>
        </div>

        <div id="projectEnPanel" class="project-lang-panel" role="tabpanel">
          <label for="projectEnTitleInput">Title</label>
          <input id="projectEnTitleInput" placeholder="Title" />
          <label for="projectEnDateInput">Date range</label>
          <input id="projectEnDateInput" placeholder="Date range" />
          <label for="projectEnDescInput">Description</label>
          <textarea id="projectEnDescInput" rows="3" placeholder="Description"></textarea>
        </div>

        <div id="projectFrPanel" class="project-lang-panel" role="tabpanel" hidden>
          <label for="projectFrTitleInput">Titre</label>
          <input id="projectFrTitleInput" placeholder="Titre" />
          <label for="projectFrDateInput">Période</label>
          <input id="projectFrDateInput" placeholder="Période" />
          <label for="projectFrDescInput">Description</label>
          <textarea id="projectFrDescInput" rows="3" placeholder="Description"></textarea>
        </div>

        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem;">
          <button type="button" id="projectEditDelete" class="lang-btn" style="margin-right:auto;">Delete</button>
          <button type="button" id="projectEditCancel" class="lang-btn">Cancel</button>
          <button type="submit" class="lang-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .admin-home-card { display: grid; gap: .75rem; }
    .admin-home-top { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .admin-home-image { width: 140px; height: 140px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border); }
    .admin-home-image-meta { display: grid; gap: .25rem; min-width: 0; }
    .admin-home-columns { display: grid; gap: .75rem; grid-template-columns: 1fr; }
    .admin-home-col { min-width: 0; }
    .admin-home-actions { display: flex; gap: .5rem; flex-wrap: wrap; }

    @media (min-width: 900px) {
      .admin-home-columns { grid-template-columns: 1fr 1fr; }
    }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: grid; place-items: center; z-index: 1000; }
    .modal-overlay[hidden] { display: none !important; }
    .modal { background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 1rem; border-radius: 12px; width: min(520px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,0.15); max-height: 88vh; overflow: auto; }
    .project-modal { width: min(470px, 92vw); }
    .project-lang-tabs { display: inline-flex; gap: .5rem; margin-top: .25rem; }
    .project-lang-tab { border: 1px solid var(--border); background: rgba(127, 127, 127, 0.08); color: var(--text); border-radius: 999px; padding: .3rem .75rem; cursor: pointer; font-weight: 600; }
    .project-lang-tab.active { border-color: rgba(127, 127, 127, 0.35); color: var(--brand); }
    .project-lang-panel { display: grid; gap: .5rem; }
    .project-lang-panel[hidden] { display: none !important; }
    .modal input, .modal textarea, .modal select { width: 100%; padding: 0.6rem 0.75rem; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); font: inherit; transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease; }
    .modal input::placeholder, .modal textarea::placeholder { color: var(--muted); opacity: 0.85; }
    .modal input:focus, .modal textarea:focus, .modal select:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 3px rgba(50, 69, 255, 0.2); }
  </style>
</Layout>
