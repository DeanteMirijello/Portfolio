---
import Layout from "../layouts/Layout.astro";
import Nav from "../components/nav.astro";
const API_BASE_VALUE = import.meta.env.PUBLIC_API_BASE || "http://localhost:3001";
---

<Layout>
  <Nav />

  <main data-api-base={API_BASE_VALUE}>

    <section class="admin-layout">
      <aside class="admin-sidebar">
        <button class="sidebar-btn" data-section="home">Home</button>
        <button class="sidebar-btn" data-section="about">About</button>
        <button class="sidebar-btn" data-section="skills">Skills</button>
        <button class="sidebar-btn" data-section="projects">Projects</button>
        <button class="sidebar-btn" data-section="testimonials">Testimonials</button>
        
      </aside>

      <div class="admin-content">
                <!-- Projects management -->
                <div id="section-projects" class="admin-section" hidden>
                  <h2>Projects</h2>
                  <div class="card" style="margin-top:.5rem;">
                    <form id="projectsForm" style="display:grid;gap:.75rem;">
                      <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;">
                        <select id="proj_id"></select>
                        <input id="proj_new_id" placeholder="new-project-id" style="display:none;" />
                      </div>
                      <div>
                        <label class="contact-label" for="proj_image">Image URL</label>
                        <input id="proj_image" placeholder="/assets/image1.png" />
                      </div>
                      <div style="display:grid;gap:.5rem;grid-template-columns:1fr 1fr;">
                        <div>
                          <h3 style="margin:.25rem 0;">English</h3>
                          <input id="proj_en_title" placeholder="Title" />
                          <input id="proj_en_date" placeholder="Date range" />
                          <textarea id="proj_en_desc" placeholder="Description" rows="3"></textarea>
                        </div>
                        <div>
                          <h3 style="margin:.25rem 0;">Français</h3>
                          <input id="proj_fr_title" placeholder="Titre" />
                          <input id="proj_fr_date" placeholder="Période" />
                          <textarea id="proj_fr_desc" placeholder="Description" rows="3"></textarea>
                        </div>
                      </div>
                      <div style="display:flex;gap:.5rem;justify-content:flex-end;">
                        <button type="submit" class="lang-btn">Save</button>
                      </div>
                      <p id="projectsMsg" class="muted" style="margin-top:.25rem;"></p>
                    </form>
                  </div>
                </div>
        <!-- Home management -->
        <div id="section-home" class="admin-section" hidden>
          <h2>Home</h2>
          <div class="card" style="margin-top:.5rem; display:grid; gap:.75rem;">
            <div style="display:flex; align-items:center; gap:1rem;">
              <img id="homePreview" alt="Home image" src="" style="width:140px;height:140px;border-radius:8px;object-fit:cover;border:1px solid var(--border);" />
              <div style="display:grid; gap:.25rem;">
                <span class="muted" id="homeImageUrl">/assets/image1.png</span>
                <div>
                  <button type="button" class="lang-btn" id="homeEditImage">Edit Image</button>
                </div>
              </div>
            </div>
            <div style="display:grid; gap:.5rem; grid-template-columns:1fr 1fr;">
              <div>
                <h3 style="margin:.25rem 0;">English</h3>
                <p style="margin:.25rem 0;"><strong>Title:</strong> <span id="homeTitleEn"></span></p>
                <p style="margin:.25rem 0;"><strong>Description:</strong><br /><span id="homeSubtitleEn" class="muted"></span></p>
                <p style="margin:.25rem 0;"><strong>Currently working on:</strong> <span id="homeCurrentEn" class="muted"></span></p>
                <div style="display:flex; gap:.5rem;">
                  <button type="button" class="lang-btn" id="homeEditTitle">Edit Title</button>
                  <button type="button" class="lang-btn" id="homeEditSubtitle">Edit Description</button>
                  <button type="button" class="lang-btn" id="homeEditCurrent">Edit Current</button>
                </div>
              </div>
              <div>
                <h3 style="margin:.25rem 0;">Français</h3>
                <p style="margin:.25rem 0;"><strong>Titre:</strong> <span id="homeTitleFr"></span></p>
                <p style="margin:.25rem 0;"><strong>Description:</strong><br /><span id="homeSubtitleFr" class="muted"></span></p>
                <p style="margin:.25rem 0;"><strong>En cours:</strong> <span id="homeCurrentFr" class="muted"></span></p>
              </div>
            </div>
            <p id="homeMsg" class="muted" style="margin-top:.25rem;"></p>
          </div>
        </div>
        <!-- About management (now includes Contact editing) -->
        <div id="section-about" class="admin-section" hidden>
          <h2>About</h2>
          <div style="display:flex; gap:.5rem; align-items:center; margin-top:.5rem;">
            <label for="aboutEditSelect" class="contact-label">Edit section</label>
            <select id="aboutEditSelect" style="width:220px;">
              <option value="work" selected>Work Experience</option>
              <option value="contact">Contact Info</option>
            </select>
          </div>
          <!-- Work Experience editing -->
          <div id="aboutWorkCard" class="card" style="margin-top:.5rem; display:grid; gap:.5rem;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <h3 style="margin:0;">Work Experience</h3>
              <div style="display:inline-flex; gap:.5rem;">
                <button type="button" id="workEditEnBtn" class="lang-btn">Edit EN</button>
                <button type="button" id="workEditFrBtn" class="lang-btn">Edit FR</button>
              </div>
            </div>
            <div style="display:grid; gap:.25rem; grid-template-columns:1fr 1fr;">
              <div>
                <p style="margin:.25rem 0;"><strong>Company:</strong> <span id="workCompany"></span></p>
                <p style="margin:.25rem 0;"><strong>Role (EN):</strong> <span id="workRoleEn" class="muted"></span></p>
                <p style="margin:.25rem 0;"><strong>Date (EN):</strong> <span id="workDateEn" class="muted"></span></p>
                <div>
                  <strong>Bullets (EN):</strong>
                  <ul id="workBulletsEn" class="clean-list" style="margin:.25rem 0 0;"></ul>
                </div>
              </div>
              <div>
                <p style="margin:.25rem 0;"><strong>Rôle (FR):</strong> <span id="workRoleFr" class="muted"></span></p>
                <p style="margin:.25rem 0;"><strong>Période (FR):</strong> <span id="workDateFr" class="muted"></span></p>
                <div>
                  <strong>Puces (FR):</strong>
                  <ul id="workBulletsFr" class="clean-list" style="margin:.25rem 0 0;"></ul>
                </div>
              </div>
            </div>
            <p id="workMsg" class="muted" style="margin-top:.25rem;"></p>
          </div>
          <!-- Contact editing UI moved here -->
          <div id="aboutContactCard" class="card" style="margin-top:.5rem;">
            <div style="display:flex;justify-content:flex-end;gap:.5rem;">
              <button type="button" id="contactAddBtn" class="lang-btn">Add</button>
            </div>
            <div id="contactItems" class="contact-card" style="margin-top:.75rem;"></div>
            <p id="adminContactMsg" class="muted" style="margin-top:.5rem;"></p>
          </div>
        </div>

        <!-- Skills management (moved out of About) -->
        <div id="section-skills" class="admin-section" hidden>
          <h2>Skills</h2>
          <div class="card" style="margin-top:.5rem; display:grid; gap:.75rem;">
            <div style="display:flex; gap:.5rem; align-items:center; justify-content:flex-end;">
              <button type="button" id="about_type_add" class="lang-btn">Add Skill Type</button>
            </div>
            <div id="about_skills_list" style="display:grid; gap:.75rem;"></div>
            <p id="aboutMsg" class="muted" style="margin-top:.25rem;"></p>
          </div>
        </div>

        <!-- Testimonials management -->
        <div id="section-testimonials" class="admin-section" hidden>
          <h2>Testimonials</h2>
          <div class="card" style="margin-top:.5rem;">
            <form id="newTestimonialForm" style="display:grid;gap:.5rem;">
              <input id="t_author" placeholder="Author" />
              <textarea id="t_message" placeholder="Message" rows="3"></textarea>
              <div style="display:flex;gap:.5rem;justify-content:flex-end;">
                <button type="submit" class="lang-btn">Add</button>
              </div>
            </form>
          </div>

          <div id="testimonialsList" style="margin-top:1rem;display:grid;gap:.75rem;"></div>
        </div>

        
      </div>
    </section>
  </main>

  <script type="module">
    const API_BASE = (() => {
      const envBase = document.querySelector("main").dataset.apiBase;
      const host = location.hostname;
      if (host === "localhost" || host === "127.0.0.1") return "http://localhost:3001";
      return envBase;
    })();

    // Sidebar switching
    const sections = {
      home: document.getElementById("section-home"),
      about: document.getElementById("section-about"),
      skills: document.getElementById("section-skills"),
      projects: document.getElementById("section-projects"),
      testimonials: document.getElementById("section-testimonials"),
    };
    const sidebarBtns = document.querySelectorAll(".sidebar-btn");
    function showSection(key) {
      Object.values(sections).forEach((el) => (el.hidden = true));
      sections[key].hidden = false;
      sidebarBtns.forEach((b) => b.classList.toggle("active", b.dataset.section === key));
    }
    // default to Home
    showSection("home");

    sidebarBtns.forEach((btn) => btn.addEventListener("click", () => showSection(btn.dataset.section)));

    // Contact Items API with modal add/edit per item
    const cMsg = document.getElementById("adminContactMsg");
    const contactItemsDiv = document.getElementById("contactItems");
    const contactAddBtn = document.getElementById("contactAddBtn");

    let contactItems = [];
    // Expose home data globally for modal prefill
    window.__homeData = null;
    window.__workData = null;

    // Work Experience
    const workCompanyEl = document.getElementById("workCompany");
    const workRoleEnEl = document.getElementById("workRoleEn");
    const workDateEnEl = document.getElementById("workDateEn");
    const workBulletsEnEl = document.getElementById("workBulletsEn");
    const workRoleFrEl = document.getElementById("workRoleFr");
    const workDateFrEl = document.getElementById("workDateFr");
    const workBulletsFrEl = document.getElementById("workBulletsFr");
    const workEditBtn = document.getElementById("workEditBtn");
    const workMsg = document.getElementById("workMsg");

    async function loadWork() {
      workMsg.textContent = "Loading...";
      try {
        const res = await fetch(`${API_BASE}/about/work`);
        window.__workData = await res.json();
        workCompanyEl.textContent = window.__workData.company || "";
        workRoleEnEl.textContent = window.__workData.en?.role || "";
        workDateEnEl.textContent = window.__workData.en?.date || "";
        workBulletsEnEl.innerHTML = "";
        (window.__workData.en?.bullets || []).forEach((b) => {
          const li = document.createElement("li");
          li.textContent = b;
          workBulletsEnEl.appendChild(li);
        });
        workRoleFrEl.textContent = window.__workData.fr?.role || "";
        workDateFrEl.textContent = window.__workData.fr?.date || "";
        workBulletsFrEl.innerHTML = "";
        (window.__workData.fr?.bullets || []).forEach((b) => {
          const li = document.createElement("li");
          li.textContent = b;
          workBulletsFrEl.appendChild(li);
        });
        workMsg.textContent = "";
      } catch (e) {
        console.error(e);
        workMsg.textContent = "Failed to load work experience.";
      }
    }

    function renderContactItems() {
      contactItemsDiv.innerHTML = "";
      if (!contactItems.length) {
        contactItemsDiv.innerHTML = '<p class="muted">No contact items yet.</p>';
        return;
      }
      contactItems.forEach((item) => {
        const row = document.createElement("div");
        row.className = "contact-row";
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.justifyContent = "space-between";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "1rem";

        const label = document.createElement("span");
        label.className = "contact-label";
        const lang = window.__lang || "en";
        label.textContent = (lang === "fr" ? item.titleFr : item.titleEn) || item.title || "";

        const valueCell = document.createElement("div");
        const v = item.value || "";
        const isEmail = v.includes("@") && !/^https?:\/\//i.test(v);
        const isUrl = /^https?:\/\//i.test(v);
        if (isEmail || isUrl) {
          const a = document.createElement("a");
          a.className = "contact-link";
          a.href = isEmail ? `mailto:${v}` : v;
          a.target = "_blank";
          a.rel = "noreferrer";
          a.textContent = isEmail ? v : v.replace(/^https?:\/\//i, "");
          valueCell.appendChild(a);
        } else {
          const span = document.createElement("span");
          span.className = "contact-value";
          span.textContent = v;
          valueCell.appendChild(span);
        }

        left.appendChild(label);
        left.appendChild(valueCell);

        const editBtn = document.createElement("button");
        editBtn.className = "lang-btn";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => openModal("contactItem", "edit", item));

        row.appendChild(left);
        row.appendChild(editBtn);
        contactItemsDiv.appendChild(row);
      });
    }

    async function loadContactItems() {
      cMsg.textContent = "Loading...";
      try {
        const res = await fetch(`${API_BASE}/contact/items`);
        contactItems = await res.json();
        if (!contactItems.length) {
          const res2 = await fetch(`${API_BASE}/contact`);
          const base = await res2.json();
          const seedPairs = [
            ["Location", base.location],
            ["Email", base.email],
            ["GitHub", base.github],
            ["LinkedIn", base.linkedin],
          ];
          for (const [title, value] of seedPairs) {
            if (value) {
              await fetch(`${API_BASE}/contact/items`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title, value }),
              });
            }
          }
          const res3 = await fetch(`${API_BASE}/contact/items`);
          contactItems = await res3.json();
        }
        renderContactItems();
        cMsg.textContent = "";
      } catch (e) {
        console.error(e);
        cMsg.textContent = "Failed to load contact items.";
      }
    }

    // Shared Admin Modal (used for Contact and About/Skills)
    const modal = document.getElementById("adminModal");
    const modalTitle = document.getElementById("adminModalTitle");
    const modalForm = document.getElementById("adminModalForm");
    const mTitle = document.getElementById("modal_title");
    const mValue = document.getElementById("modal_value");
    const modalCancel = document.getElementById("adminModalCancel");
    const mEnTitle = document.getElementById("modal_en_title");
    const mFrTitle = document.getElementById("modal_fr_title");
    const mEnDesc = document.getElementById("modal_en_desc");
    const mFrDesc = document.getElementById("modal_fr_desc");
    const mEnDate = document.getElementById("modal_en_date");
    const mFrDate = document.getElementById("modal_fr_date");
    const modalDelete = document.getElementById("adminModalDelete");
    const aboutEditSelect = document.getElementById("aboutEditSelect");
    const aboutWorkCard = document.getElementById("aboutWorkCard");
    const aboutContactCard = document.getElementById("aboutContactCard");
    function updateAboutEditView() {
      const v = aboutEditSelect?.value || "work";
      if (aboutWorkCard) {
        aboutWorkCard.hidden = v !== "work";
        aboutWorkCard.style.display = v === "work" ? "grid" : "none";
      }
      if (aboutContactCard) {
        aboutContactCard.hidden = v !== "contact";
        aboutContactCard.style.display = v === "contact" ? "block" : "none";
      }
    }
    if (aboutEditSelect) {
      aboutEditSelect.addEventListener("change", updateAboutEditView);
      updateAboutEditView();
    }
    // Open add contact item modal
    contactAddBtn.addEventListener("click", () => openModal("contactItem", "add"));
    const workEditEnBtn = document.getElementById("workEditEnBtn");
    const workEditFrBtn = document.getElementById("workEditFrBtn");
    if (workEditEnBtn) workEditEnBtn.addEventListener("click", () => openModal("workExpEn", "edit"));
    if (workEditFrBtn) workEditFrBtn.addEventListener("click", () => openModal("workExpFr", "edit"));

    function openModal(context, mode, data) {
      modal.dataset.context = context;
      modal.dataset.mode = mode;
      modal.dataset.itemId = data?.id || "";
      modal.dataset.category = data?.category || "";
      modal.dataset.typeName = data?.name || "";
      if (context === "contactItem") {
        modalTitle.textContent = mode === "add" ? "Add Contact Item" : "Edit Contact Item";
        // Show EN/FR titles and value; move delete into modal for edit mode
        mTitle.style.display = "none";
        label_title.style.display = "none";
        mValue.style.display = "block";
        label_value.style.display = "block"; label_value.textContent = "Value";
        mEnTitle.style.display = "block"; label_en_title.style.display = "block"; label_en_title.textContent = "Title (EN)";
        mFrTitle.style.display = "block"; label_fr_title.style.display = "block"; label_fr_title.textContent = "Title (FR)";
        mEnDate.style.display = "none"; label_en_date.style.display = "none";
        mFrDate.style.display = "none"; label_fr_date.style.display = "none";
        mEnDesc.style.display = "none"; label_en_desc.style.display = "none";
        mFrDesc.style.display = "none"; label_fr_desc.style.display = "none";
        modalDelete.style.display = mode === "edit" ? "inline-block" : "none";
        mEnTitle.value = data?.titleEn || data?.title || "";
        mFrTitle.value = data?.titleFr || data?.title || "";
        mValue.value = data?.value || "";
      } else if (context === "skillType") {
        modalTitle.textContent = mode === "add" ? "Add Skill Type" : "Edit Skill Type";
        mTitle.style.display = "none";
        mValue.style.display = "none";
        mEnTitle.style.display = "block";
        mFrTitle.style.display = "block";
        modalDelete.style.display = mode === "edit" ? "inline-block" : "none";
        // Prefill titles if available (edit)
        const baseName = data?.name;
        const t = window.__skillsTitles?.[baseName] || { en: baseName || "", fr: baseName || "" };
        mEnTitle.value = t.en || "";
        mFrTitle.value = t.fr || "";
      } else if (context === "skillItem") {
        modalTitle.textContent = mode === "add" ? "Add Skill" : "Edit Skill";
        mTitle.style.display = "none";
        mValue.style.display = "block";
        mEnTitle.style.display = "none";
        mFrTitle.style.display = "none";
        mEnDesc.style.display = "none";
        mFrDesc.style.display = "none";
        modalDelete.style.display = mode === "edit" ? "inline-block" : "none";
        mTitle.value = "";
        mValue.value = data?.value || "";
      } else if (context === "homeField") {
        const field = data?.field;
        modal.dataset.homeField = field || "";
        modalTitle.textContent = `Edit Home ${field}`;
        // Reset visibility
        mTitle.style.display = "none";
        mValue.style.display = "none";
        mEnTitle.style.display = "none";
        mFrTitle.style.display = "none";
        mEnDesc.style.display = "none";
        mFrDesc.style.display = "none";
        modalDelete.style.display = "none";
        // Prefill based on field
        if (field === "image") {
          mValue.style.display = "block";
          mValue.value = window.__homeData?.image || "";
        } else if (field === "title" || field === "current") {
          mEnTitle.style.display = "block";
          mFrTitle.style.display = "block";
          mEnTitle.value = window.__homeData?.en?.[field] || "";
          mFrTitle.value = window.__homeData?.fr?.[field] || "";
        } else if (field === "subtitle") {
          mEnDesc.style.display = "block";
          mFrDesc.style.display = "block";
          mEnDesc.value = window.__homeData?.en?.subtitle || "";
          mFrDesc.value = window.__homeData?.fr?.subtitle || "";
        }
      } else if (context === "workExpEn") {
        modalTitle.textContent = "Edit Work (English)";
        // Only EN fields
        mTitle.style.display = "none";
        label_title.style.display = "none";
        mValue.style.display = "none";
        label_value.style.display = "none";

        modal_en_heading.style.display = "block"; modal_en_heading.textContent = "English";
        mEnTitle.style.display = "block"; label_en_title.style.display = "block"; label_en_title.textContent = "Role (EN)";
        mEnDate.style.display = "block"; label_en_date.style.display = "block"; label_en_date.textContent = "Date (EN)";
        mEnDesc.style.display = "block"; label_en_desc.style.display = "block"; label_en_desc.textContent = "Bullets (one per line)";

        modal_fr_heading.style.display = "none";
        mFrTitle.style.display = "none"; label_fr_title.style.display = "none";
        mFrDate.style.display = "none"; label_fr_date.style.display = "none";
        mFrDesc.style.display = "none"; label_fr_desc.style.display = "none";
        modalDelete.style.display = "none";
        mEnTitle.value = window.__workData?.en?.role || "";
        mEnDate.value = window.__workData?.en?.date || "";
        mEnDesc.value = (window.__workData?.en?.bullets || []).join("\n");
      } else if (context === "workExpFr") {
        modalTitle.textContent = "Modifier le travail (Français)";
        // Only FR fields
        mTitle.style.display = "none";
        label_title.style.display = "none";
        mValue.style.display = "none";
        label_value.style.display = "none";

        modal_en_heading.style.display = "none";
        mEnTitle.style.display = "none"; label_en_title.style.display = "none";
        mEnDate.style.display = "none"; label_en_date.style.display = "none";
        mEnDesc.style.display = "none"; label_en_desc.style.display = "none";

        modal_fr_heading.style.display = "block"; modal_fr_heading.textContent = "Français";
        mFrTitle.style.display = "block"; label_fr_title.style.display = "block"; label_fr_title.textContent = "Rôle (FR)";
        mFrDate.style.display = "block"; label_fr_date.style.display = "block"; label_fr_date.textContent = "Période (FR)";
        mFrDesc.style.display = "block"; label_fr_desc.style.display = "block"; label_fr_desc.textContent = "Puces (une par ligne)";
        modalDelete.style.display = "none";
        mFrTitle.value = window.__workData?.fr?.role || "";
        mFrDate.value = window.__workData?.fr?.date || "";
        mFrDesc.value = (window.__workData?.fr?.bullets || []).join("\n");
      }
      modal.hidden = false;
    }

    function closeModal() {
      modal.hidden = true;
      modal.dataset.context = "";
      modal.dataset.mode = "";
      modal.dataset.itemId = "";
      // Clear messages
      if (typeof cMsg !== "undefined") cMsg.textContent = "";
      if (typeof aboutMsg !== "undefined") aboutMsg.textContent = "";
    }

    modalCancel.addEventListener("click", closeModal);

    modalForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const context = modal.dataset.context;
      const mode = modal.dataset.mode;
      try {
        if (context === "contactItem") {
          cMsg.textContent = "Saving...";
          const payload = { titleEn: mEnTitle.value.trim(), titleFr: mFrTitle.value.trim(), value: mValue.value.trim() };
          const itemId = modal.dataset.itemId;
          const url = mode === "edit" ? `${API_BASE}/contact/items/${itemId}` : `${API_BASE}/contact/items`;
          const method = mode === "edit" ? "PUT" : "POST";
          const res = await fetch(url, { method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
          const data = await res.json();
          if (!res.ok) { cMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          closeModal();
          await loadContactItems();
          cMsg.textContent = "Saved.";
        } else if (context === "skillType") {
          aboutMsg.textContent = "Saving...";
          const selected = modal.dataset.typeName;
          if (mode === "add") {
            // Create type key from English title (simple slug)
            const en = mEnTitle.value.trim();
            const fr = mFrTitle.value.trim();
            const name = en.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "") || en;
            const res = await fetch(`${API_BASE}/skills/types`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
            const res2 = await fetch(`${API_BASE}/skills/types/${encodeURIComponent(name)}/titles`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ en, fr }) });
            const data2 = await res2.json();
            if (!res2.ok) { aboutMsg.textContent = (data2.errors?.[0]?.msg) || data2.error || "Save failed"; return; }
          } else {
            // Save bilingual titles for the selected type
            const res = await fetch(`${API_BASE}/skills/types/${encodeURIComponent(selected)}/titles`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ en: mEnTitle.value.trim(), fr: mFrTitle.value.trim() }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          }
          closeModal();
          await loadAboutSkills();
          aboutMsg.textContent = "Saved.";
        } else if (context === "skillItem") {
          aboutMsg.textContent = "Saving...";
          const category = modal.dataset.category;
          const value = mValue.value.trim();
          if (mode === "add") {
            const res = await fetch(`${API_BASE}/skills/items`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ category, value }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          } else {
            const oldValue = modal.dataset.itemId;
            const res = await fetch(`${API_BASE}/skills/items`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ category, oldValue, newValue: value }) });
            const data = await res.json();
            if (!res.ok) { aboutMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          }
          closeModal();
          await loadAboutSkills();
          aboutMsg.textContent = "Saved.";
        } else if (context === "homeField") {
          hMsg.textContent = "Saving...";
          const field = modal.dataset.homeField;
          // Build payload from current home data to avoid resetting other fields to defaults
          const base = window.__homeData || {};
          const payload = {
            image: base.image,
            en: { ...(base.en || {}) },
            fr: { ...(base.fr || {}) },
          };
          if (field === "image") {
            payload.image = mValue.value.trim() || base.image || "";
          } else if (field === "title") {
            payload.en.title = mEnTitle.value.trim();
            payload.fr.title = mFrTitle.value.trim();
          } else if (field === "subtitle") {
            payload.en.subtitle = mEnDesc.value.trim();
            payload.fr.subtitle = mFrDesc.value.trim();
          } else if (field === "current") {
            payload.en.current = mEnTitle.value.trim();
            payload.fr.current = mFrTitle.value.trim();
          }
          const res = await fetch(`${API_BASE}/home`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) { hMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          closeModal();
          await loadHome();
          hMsg.textContent = "Saved.";
        } else if (context === "workExpEn") {
          workMsg.textContent = "Saving...";
          const base = window.__workData || {};
          const payload = {
            company: base.company,
            en: {
              role: mEnTitle.value.trim(),
              date: mEnDate.value.trim(),
              bullets: mEnDesc.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean),
            },
            fr: base.fr || {},
          };
          const res = await fetch(`${API_BASE}/about/work`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) { workMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          closeModal();
          await loadWork();
          workMsg.textContent = "Saved.";
        } else if (context === "workExpFr") {
          workMsg.textContent = "Saving...";
          const base = window.__workData || {};
          const payload = {
            company: base.company,
            en: base.en || {},
            fr: {
              role: mFrTitle.value.trim(),
              date: mFrDate.value.trim(),
              bullets: mFrDesc.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean),
            },
          };
          const res = await fetch(`${API_BASE}/about/work`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) { workMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed"; return; }
          closeModal();
          await loadWork();
          workMsg.textContent = "Saved.";
        }
      } catch (err) {
        console.error(err);
        if (context === "contactItem") cMsg.textContent = "Network error";
        else if (context === "skillType" || context === "skillItem") aboutMsg.textContent = "Network error";
        else hMsg.textContent = "Network error";
      }
    });

    // Modal delete actions (skillType edit, skillItem edit, contactItem edit)
    modalDelete.addEventListener("click", async () => {
      const context = modal.dataset.context;
      try {
        if (context === "skillType") {
          const name = modal.dataset.typeName || (mEnTitle.value.trim().toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "") || mEnTitle.value.trim());
          if (!confirm("Delete this type and all its skills?")) return;
          const res = await fetch(`${API_BASE}/skills/types/${encodeURIComponent(name)}`, { method: "DELETE" });
          if (res.ok) { closeModal(); loadAboutSkills(); }
        } else if (context === "skillItem") {
          const category = modal.dataset.category;
          const oldValue = modal.dataset.itemId;
          if (!confirm("Delete this skill?")) return;
          const res = await fetch(`${API_BASE}/skills/items`, { method: "DELETE", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ category, value: oldValue }) });
          if (res.ok) { closeModal(); loadAboutSkills(); }
        } else if (context === "contactItem") {
          const itemId = modal.dataset.itemId;
          if (!confirm("Delete this contact item?")) return;
          const res = await fetch(`${API_BASE}/contact/items/${itemId}`, { method: "DELETE" });
          if (res.ok) { closeModal(); loadContactItems(); }
        }
      } catch (e) { console.error(e); }
    });

    async function deleteContactItem(id) {
      if (!confirm("Delete this contact item?")) return;
      try {
        const res = await fetch(`${API_BASE}/contact/items/${id}`, { method: "DELETE" });
        if (res.ok) {
          await loadContactItems();
        }
      } catch (e) {
        console.error(e);
      }
    }

    // Testimonials API
    const tList = document.getElementById("testimonialsList");
    const tForm = document.getElementById("newTestimonialForm");
    const tAuthor = document.getElementById("t_author");
    const tMessage = document.getElementById("t_message");

    async function renderTestimonials() {
      tList.innerHTML = "Loading...";
      try {
        const res = await fetch(`${API_BASE}/testimonials`);
        const items = await res.json();
        tList.innerHTML = "";
        items.forEach((t) => {
          const card = document.createElement("div");
          card.className = "card";
          card.style.padding = "0.75rem";
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;">
              <strong>${t.author}</strong>
              <div style="display:flex;gap:.5rem;">
                <button class="lang-btn" data-edit="${t.id}">Edit</button>
                <button class="lang-btn" data-del="${t.id}">Delete</button>
              </div>
            </div>
            <p style="margin:.5rem 0 0">${t.message}</p>
          `;
          const editBtn = card.querySelector(`[data-edit="${t.id}"]`);
          const delBtn = card.querySelector(`[data-del="${t.id}"]`);
          editBtn.addEventListener("click", () => editTestimonial(t));
          delBtn.addEventListener("click", () => deleteTestimonial(t.id));
          tList.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        tList.textContent = "Failed to load testimonials.";
      }
    }

    tForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = { author: tAuthor.value.trim(), message: tMessage.value.trim() };
      if (!payload.author || !payload.message) return;
      try {
        const res = await fetch(`${API_BASE}/testimonials`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (res.ok) {
          tAuthor.value = "";
          tMessage.value = "";
          renderTestimonials();
        }
      } catch (e) {
        console.error(e);
      }
    });

    async function editTestimonial(item) {
      const newAuthor = prompt("Edit author", item.author);
      if (newAuthor === null) return;
      const newMessage = prompt("Edit message", item.message);
      if (newMessage === null) return;
      try {
        await fetch(`${API_BASE}/testimonials/${item.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ author: newAuthor, message: newMessage }),
        });
        renderTestimonials();
      } catch (e) {
        console.error(e);
      }
    }

    async function deleteTestimonial(id) {
      if (!confirm("Delete this testimonial?")) return;
      try {
        await fetch(`${API_BASE}/testimonials/${id}`, { method: "DELETE" });
        renderTestimonials();
      } catch (e) {
        console.error(e);
      }
    }

    // About/Skills management
    const aboutTypeAddBtn = document.getElementById("about_type_add");
    const aboutTypeRenameBtn = document.getElementById("about_type_rename");
    const aboutTypeDeleteBtn = document.getElementById("about_type_delete");
    const aboutSkillsList = document.getElementById("about_skills_list");
    const aboutMsg = document.getElementById("aboutMsg");

    let skillsData = {};

    async function loadAboutSkills() {
      aboutSkillsList.innerHTML = "Loading...";
      try {
        const [skillsRes, titlesRes] = await Promise.all([
          fetch(`${API_BASE}/skills`),
          fetch(`${API_BASE}/skills/titles`),
        ]);
        skillsData = await skillsRes.json();
        window.__skillsTitles = await titlesRes.json();
        renderAboutSkills();
        aboutMsg.textContent = "";
      } catch (e) {
        console.error(e);
        aboutSkillsList.textContent = "Failed to load skills.";
      }
    }

    function renderAboutSkills() {
      aboutSkillsList.innerHTML = "";
      Object.entries(skillsData).forEach(([cat, arr]) => {
        const block = document.createElement("div");
        block.className = "card";
        const header = document.createElement("div");
        header.style.display = "flex";
        header.style.alignItems = "center";
        header.style.justifyContent = "space-between";
        const titleEl = document.createElement("h3");
        titleEl.style.marginTop = "0";
        titleEl.style.textTransform = "capitalize";
        titleEl.textContent = (window.__skillsTitles?.[cat]?.en || cat);
        const subtitleEl = document.createElement("p");
        subtitleEl.className = "muted";
        subtitleEl.style.margin = "0";
        subtitleEl.textContent = window.__skillsTitles?.[cat]?.fr ? `FR: ${window.__skillsTitles[cat].fr}` : "";
        const titleWrap = document.createElement("div");
        titleWrap.appendChild(titleEl);
        if (subtitleEl.textContent) titleWrap.appendChild(subtitleEl);
        const actions = document.createElement("div");
        actions.style.display = "inline-flex";
        actions.style.gap = ".5rem";
        const editTypeBtn = document.createElement("button");
        editTypeBtn.className = "lang-btn";
        editTypeBtn.textContent = "Edit Type";
        editTypeBtn.addEventListener("click", () => openModal("skillType", "edit", { name: cat }));
        const addSkillBtn = document.createElement("button");
        addSkillBtn.className = "lang-btn";
        addSkillBtn.textContent = "Add Skill";
        addSkillBtn.addEventListener("click", () => openModal("skillItem", "add", { category: cat }));
        actions.appendChild(editTypeBtn);
        actions.appendChild(addSkillBtn);
        header.appendChild(titleWrap);
        header.appendChild(actions);
        block.appendChild(header);
        const tags = document.createElement("div");
        tags.className = "tags";
        arr.forEach((val) => {
          const tag = document.createElement("span");
          tag.className = "tag";
          tag.textContent = val;
          tag.style.cursor = "pointer";
          tag.title = "Click to edit";
          tag.addEventListener("click", () => openModal("skillItem", "edit", { id: val, value: val, category: cat }));
          tags.appendChild(tag);
        });
        block.appendChild(tags);
        aboutSkillsList.appendChild(block);
      });
    }
    aboutTypeAddBtn.addEventListener("click", () => openModal("skillType", "add"));

    // Initial loads
    // Home
    // Removed form inputs; using modal-based editing
    const hMsg = document.getElementById("homeMsg");

    async function loadHome() {
      try {
        const res = await fetch(`${API_BASE}/home`);
        window.__homeData = await res.json();
        // Populate display elements if present
        if (homePreview) homePreview.src = window.__homeData.image || "";
        if (homeImageUrl) homeImageUrl.textContent = window.__homeData.image || "";
        if (homeTitleEnEl) homeTitleEnEl.textContent = window.__homeData.en?.title || "";
        if (homeTitleFrEl) homeTitleFrEl.textContent = window.__homeData.fr?.title || "";
        if (homeSubtitleEnEl) homeSubtitleEnEl.textContent = window.__homeData.en?.subtitle || "";
        if (homeSubtitleFrEl) homeSubtitleFrEl.textContent = window.__homeData.fr?.subtitle || "";
        if (homeCurrentEnEl) homeCurrentEnEl.textContent = window.__homeData.en?.current || "";
        if (homeCurrentFrEl) homeCurrentFrEl.textContent = window.__homeData.fr?.current || "";
      } catch (e) {
        console.error(e);
        hMsg.textContent = "Failed to load home content.";
      }
    }

    // Home field edit handlers using modal
    const homePreview = document.getElementById("homePreview");
    const homeImageUrl = document.getElementById("homeImageUrl");
    const homeEditImageBtn = document.getElementById("homeEditImage");
    const homeTitleEnEl = document.getElementById("homeTitleEn");
    const homeTitleFrEl = document.getElementById("homeTitleFr");
    const homeSubtitleEnEl = document.getElementById("homeSubtitleEn");
    const homeSubtitleFrEl = document.getElementById("homeSubtitleFr");
    const homeCurrentEnEl = document.getElementById("homeCurrentEn");
    const homeCurrentFrEl = document.getElementById("homeCurrentFr");
    const homeEditTitleBtn = document.getElementById("homeEditTitle");
    const homeEditSubtitleBtn = document.getElementById("homeEditSubtitle");
    const homeEditCurrentBtn = document.getElementById("homeEditCurrent");

    if (homeEditImageBtn) homeEditImageBtn.addEventListener("click", () => openModal("homeField", "edit", { field: "image" }));
    if (homeEditTitleBtn) homeEditTitleBtn.addEventListener("click", () => openModal("homeField", "edit", { field: "title" }));
    if (homeEditSubtitleBtn) homeEditSubtitleBtn.addEventListener("click", () => openModal("homeField", "edit", { field: "subtitle" }));
    if (homeEditCurrentBtn) homeEditCurrentBtn.addEventListener("click", () => openModal("homeField", "edit", { field: "current" }));

    // Removed old form submit; edits are handled via modal submit

    // Projects
    const pForm = document.getElementById("projectsForm");
    const pMsg = document.getElementById("projectsMsg");
    const pId = document.getElementById("proj_id");
    const pInputs = {
      image: document.getElementById("proj_image"),
      en: {
        title: document.getElementById("proj_en_title"),
        date: document.getElementById("proj_en_date"),
        desc: document.getElementById("proj_en_desc"),
      },
      fr: {
        title: document.getElementById("proj_fr_title"),
        date: document.getElementById("proj_fr_date"),
        desc: document.getElementById("proj_fr_desc"),
      },
    };

    async function loadProject(id) {
      try {
        const res = await fetch(`${API_BASE}/projects/${id}`);
        const data = await res.json();
        pInputs.image.value = data.image || "";
        pInputs.en.title.value = data.en?.title || "";
        pInputs.en.date.value = data.en?.date || "";
        pInputs.en.desc.value = data.en?.desc || "";
        pInputs.fr.title.value = data.fr?.title || "";
        pInputs.fr.date.value = data.fr?.date || "";
        pInputs.fr.desc.value = data.fr?.desc || "";
      } catch (e) {
        console.error(e);
        pMsg.textContent = "Failed to load project.";
      }
    }

    pId.addEventListener("change", () => {
      const val = pId.value;
      const isNew = val === "__new__";
      document.getElementById("proj_new_id").style.display = isNew ? "inline-block" : "none";
      if (!isNew) loadProject(val);
      else {
        // Reset fields for new project
        pInputs.image.value = "";
        pInputs.en.title.value = "";
        pInputs.en.date.value = "";
        pInputs.en.desc.value = "";
        pInputs.fr.title.value = "";
        pInputs.fr.date.value = "";
        pInputs.fr.desc.value = "";
      }
    });

    pForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      pMsg.textContent = "Saving...";
      const payload = {
        image: pInputs.image.value.trim(),
        en: {
          title: pInputs.en.title.value.trim(),
          date: pInputs.en.date.value.trim(),
          desc: pInputs.en.desc.value.trim(),
        },
        fr: {
          title: pInputs.fr.title.value.trim(),
          date: pInputs.fr.date.value.trim(),
          desc: pInputs.fr.desc.value.trim(),
        },
      };
      try {
        const isNew = pId.value === "__new__";
        const idForNew = document.getElementById("proj_new_id").value.trim();
        const res = await fetch(isNew ? `${API_BASE}/projects` : `${API_BASE}/projects/${pId.value}`, {
          method: isNew ? "POST" : "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(isNew ? { id: idForNew, ...payload } : payload),
        });
        const data = await res.json();
        if (!res.ok) {
          pMsg.textContent = (data.errors?.[0]?.msg) || data.error || "Save failed";
          return;
        }
        pMsg.textContent = "Saved.";
        await loadProjectsList();
        if (isNew && idForNew) {
          pId.value = idForNew;
        }
      } catch (e) {
        console.error(e);
        pMsg.textContent = "Network error";
      }
    });

    async function loadProjectsList() {
      try {
        const res = await fetch(`${API_BASE}/projects`);
        const data = await res.json();
        pId.innerHTML = "";
        // Add existing projects
        Object.entries(data).forEach(([id, entry]) => {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = entry.en?.title || id;
          pId.appendChild(opt);
        });
        // Add New option
        const newOpt = document.createElement("option");
        newOpt.value = "__new__";
        newOpt.textContent = "New…";
        pId.appendChild(newOpt);
      } catch (e) {
        console.error(e);
      }
    }

    loadHome();
    loadWork();
    await loadProjectsList();
    pId.value = pId.options[0]?.value || "__new__";
    if (pId.value !== "__new__") loadProject(pId.value);
    loadContactItems();
    renderTestimonials();
    loadAboutSkills();
  </script>

  <!-- Admin Modal (shared; currently used for Contact Items) -->
  <div id="adminModal" class="modal-overlay" hidden>
    <div class="modal">
      <h3 id="adminModalTitle" style="margin-top:0;">Edit</h3>
      <form id="adminModalForm" style="display:grid;gap:.5rem;">
        <label id="label_title" for="modal_title" style="display:none;">Title</label>
        <input id="modal_title" placeholder="Title" />
        <label id="label_value" for="modal_value" style="display:none;">Value</label>
        <input id="modal_value" placeholder="Value" />

        <h4 id="modal_en_heading" style="margin:.25rem 0; display:none;">English</h4>
        <label id="label_en_title" for="modal_en_title" style="display:none;">English title</label>
        <input id="modal_en_title" placeholder="English title" style="display:none;" />
        <label id="label_en_date" for="modal_en_date" style="display:none;">English date range</label>
        <input id="modal_en_date" placeholder="English date range" style="display:none;" />
        <label id="label_en_desc" for="modal_en_desc" style="display:none;">English description</label>
        <textarea id="modal_en_desc" placeholder="English description" rows="4" style="display:none;"></textarea>

        <h4 id="modal_fr_heading" style="margin:.25rem 0; display:none;">Français</h4>
        <label id="label_fr_title" for="modal_fr_title" style="display:none;">French title</label>
        <input id="modal_fr_title" placeholder="French title" style="display:none;" />
        <label id="label_fr_date" for="modal_fr_date" style="display:none;">French date range</label>
        <input id="modal_fr_date" placeholder="French date range" style="display:none;" />
        <label id="label_fr_desc" for="modal_fr_desc" style="display:none;">French description</label>
        <textarea id="modal_fr_desc" placeholder="French description" rows="4" style="display:none;"></textarea>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem;">
          <button type="button" id="adminModalDelete" class="lang-btn" style="margin-right:auto;display:none;">Delete</button>
          <button type="button" id="adminModalCancel" class="lang-btn">Cancel</button>
          <button type="submit" class="lang-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: grid; place-items: center; z-index: 1000; }
    .modal-overlay[hidden] { display: none !important; }
    .modal { background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 1rem; border-radius: 12px; width: min(520px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .modal input, .modal textarea, .modal select { width: 100%; padding: 0.6rem 0.75rem; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); font: inherit; transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease; }
    .modal input::placeholder, .modal textarea::placeholder { color: var(--muted); opacity: 0.85; }
    .modal input:focus, .modal textarea:focus, .modal select:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 3px rgba(50, 69, 255, 0.2); }
  </style>
</Layout>
